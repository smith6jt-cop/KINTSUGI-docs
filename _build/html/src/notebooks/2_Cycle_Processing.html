
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Part 2: Batch Process &#8212; KINTSUGI</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'src/notebooks/2_Cycle_Processing';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Part 3: Isolate signal from autofluorescence and noise." href="3_Signal_Isolation.html" />
    <link rel="prev" title="Part 1: Explore data, test and tune processing parameters." href="1_Single_Channel_Eval.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../Intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cluster.gif" class="logo__image only-light" alt="KINTSUGI - Home"/>
    <img src="../../_static/cluster.gif" class="logo__image only-dark pst-js-only" alt="KINTSUGI - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../Intro.html">
                    KINTSUGI: Knowledge Integration with New Technologies for Simplified User-Guided Image processing
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Installation%20Steps.html">Installation Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Single_Channel_Eval.html">Part 1: Explore data, test and tune processing parameters.</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Part 2: Batch Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Signal_Isolation.html">Part 3: Isolate signal from autofluorescence and noise.</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Segmentation.html">Part 4: Segment cells and nuclei.</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_Cluster_Pixels.html">Part 5: Cluster pixels.</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_Cluster_Cells.html">Part 6: Cluster cells.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI/issues/new?title=Issue%20on%20page%20%2Fsrc/notebooks/2_Cycle_Processing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/src/notebooks/2_Cycle_Processing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Part 2: Batch Process</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching-and-illumination-correction">3. Stitching and Illumination Correction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching-function">3.1 Stitching Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#illumination-correction-function">3.2 Illumination Correction Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-multiple-cycle-channel-combinations">3.3 Running Multiple Cycle/Channel Combinations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">4. Deconvolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiji-clij2-plugin-edf">5. FIJI Clij2 plugin - EDF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">6. Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-channels-for-each-cycle">6.1 Combine channels for each cycle</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#valis-registration">6.2 VALIS Registration</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="part-2-batch-process">
<h1>Part 2: Batch Process<a class="headerlink" href="#part-2-batch-process" title="Link to this heading">#</a></h1>
<p>In the following notebook you will use the parameters found in A_Evaluation&amp;Testing.ipynb to correct and stitch entire datasets.</p>
<section id="import-packages">
<h2>1. Import packages.<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h2>
<p>*This must be done every time the notebook is started or restarted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">KCorrect</span>
<span class="kn">from</span> <span class="nn">Kstitch.stitching</span> <span class="kn">import</span> <span class="n">stitch_images</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">skimage.io.collection</span> <span class="kn">import</span> <span class="n">alphanumeric_key</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread_collection</span><span class="p">,</span> <span class="n">imsave</span>
<span class="kn">import</span> <span class="nn">stackview</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">imagej</span><span class="o">,</span> <span class="nn">scyjava</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="k">as</span> <span class="nn">cl</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="n">os_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
<span class="n">current_dateTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-directory-paths">
<h2>2. Define directory paths.<a class="headerlink" href="#define-directory-paths" title="Link to this heading">#</a></h2>
<p>*This must be done every time the notebook is started or restarted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">smith6jt&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;1904_CC2B_raw&#39;</span><span class="p">)</span>
<span class="n">stitch_dir</span> <span class="o">=</span> <span class="n">image_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;_BaSiC_Stitched&quot;</span><span class="p">)</span>
<span class="n">meta_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_BaSiC_Stitched&quot;</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">)</span>
<span class="n">project_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;project_data.txt&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image folder is </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stitching folder is </span><span class="si">{</span><span class="n">stitch_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Meta folder is </span><span class="si">{</span><span class="n">meta_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_raw.
Stitching folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_BaSiC_Stitched.
Meta folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_meta.
</pre></div>
</div>
</div>
</div>
</section>
<section id="stitching-and-illumination-correction">
<h2>3. Stitching and Illumination Correction<a class="headerlink" href="#stitching-and-illumination-correction" title="Link to this heading">#</a></h2>
<section id="stitching-function">
<h3>3.1 Stitching Function<a class="headerlink" href="#stitching-function" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The following cell defines the function that is called from the apply_basic function to stitch the corrected tiles.</p></li>
<li><p>It creates a file with the stitching positions calculated from the middle z-plane images of the first channel.</p></li>
<li><p>The file is then used to stitch the rest of the images for all channels in the cycle. BECAUSE OF THIS, YOU MUST HAVE RUN THE FIRST CHANNEL OF A CYCLE TO STITCH THE OTHER CHANNELS.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stitch</span><span class="p">(</span><span class="n">images_transformed</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dest_1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="p">,</span> <span class="n">pou</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">):</span>
    
    <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">zplanes</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">pkl_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;result_df.pkl&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">zplanes</span> <span class="o">==</span> <span class="n">zplanes_n</span><span class="o">//</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start Stitching Z0</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">_CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkl_dest</span><span class="p">):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">pkl_dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stitch_images</span><span class="p">(</span><span class="n">images_transformed</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">initial_ncc_threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="o">=</span><span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">pou</span><span class="o">=</span><span class="n">pou</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="n">use_gpu</span><span class="p">)</span>
            <span class="n">result_df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_dest</span><span class="p">)</span>
           
        
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start Stitching Z0</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">_CH</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_1</span><span class="p">,</span> <span class="s2">&quot;result_df.pkl&quot;</span><span class="p">)):</span>
            <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_1</span><span class="p">,</span> <span class="s2">&quot;result_df.pkl&quot;</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run registration channel to produce a stitching model.&quot;</span><span class="p">)</span>

    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="n">size_y</span> <span class="o">=</span> <span class="n">images_transformed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">size_x</span> <span class="o">=</span> <span class="n">images_transformed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">stitched_image_size</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
        <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stitched_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">images_transformed</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">stitched_image_size</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">stitched_image</span><span class="p">[</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">images_transformed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">result_image_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span> 
    <span class="n">imsave</span><span class="p">(</span><span class="n">result_image_file_path</span><span class="p">,</span> <span class="n">stitched_image</span><span class="p">,</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved to </span><span class="si">{</span><span class="n">result_image_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="illumination-correction-function">
<h3>3.2 Illumination Correction Function<a class="headerlink" href="#illumination-correction-function" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The following cell contains the function that will apply the illumination correction to your data.</p></li>
<li><p>Change the five variables below according to tests using the first notebook.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">apply_KCorrect</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">stitch_dir</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="p">,</span> <span class="n">pou</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">):</span>

    <span class="n">if_darkfield</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">optimization_tolerance</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">max_reweight_iterations</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">reweight_tolerance</span> <span class="o">=</span> <span class="mf">1.0e-3</span>

    <span class="n">filename_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;1_000??_Z0</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">zplanes</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">_CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s1">.tif&#39;</span>
    
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dest_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;CH1&quot;</span><span class="p">)</span>
    
    <span class="n">im_raw</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename_pattern</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">alphanumeric_key</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">imread_collection</span><span class="p">(</span><span class="n">im_raw</span><span class="p">)</span>
    <span class="n">im_array_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">dtype_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="n">im_array</span> <span class="o">=</span> <span class="n">im_array_init</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="n">dtype_max</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input array contains inf or nan values&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">im_array</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input array contains negative values&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start Illumination Correction cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> Z0</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">zplanes</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">_CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">flatfield</span><span class="p">,</span> <span class="n">darkfield</span> <span class="o">=</span> <span class="n">KCorrect</span><span class="o">.</span><span class="n">KCorrect</span><span class="p">(</span><span class="n">im_array</span><span class="p">,</span> <span class="n">if_darkfield</span> <span class="o">=</span> <span class="n">if_darkfield</span><span class="p">,</span> <span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="n">optimization_tolerance</span> <span class="o">=</span> <span class="n">optimization_tolerance</span><span class="p">,</span>  <span class="n">max_reweight_iterations</span> <span class="o">=</span> <span class="n">max_reweight_iterations</span><span class="p">,</span> <span class="n">reweight_tolerance</span> <span class="o">=</span> <span class="n">reweight_tolerance</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flatfield</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">darkfield</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid flatfield or darkfield correction&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">flatfield</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Flatfield contains zero values which may cause division issues&quot;</span><span class="p">)</span>
    
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">im_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
        <span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">darkfield</span><span class="p">)</span> <span class="o">/</span> <span class="n">flatfield</span><span class="p">)</span>
        <span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
    <span class="n">KCorrect</span><span class="o">.</span><span class="n">validate_correction</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">,</span> <span class="n">corrected</span><span class="p">)</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrected</span> <span class="o">*</span> <span class="n">dtype_max</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>                                       
    <span class="n">stitch</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dest_1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="p">,</span> <span class="n">pou</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-multiple-cycle-channel-combinations">
<h3>3.3 Running Multiple Cycle/Channel Combinations<a class="headerlink" href="#running-multiple-cycle-channel-combinations" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This cell runs the above two functions for all the images you define with start_cycle, end_cycle, start_channel, and end_channel.</p></li>
<li><p>Enter values for n, m, pou (determined from the first notebook), zplanes_n (number of zplanes), and overlap_percentage.</p></li>
<li><p>Enter the number of workers for the multithreading (usually determined by dataset size, available memory, and number of cores).  See <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">https://docs.python.org/3/library/concurrent.futures.html</a></p></li>
<li><p>To run just one cycle or channel, simply enter the same number for both start and end.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># Number of rows (height)</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Number of columns (width)</span>
<span class="n">start_cycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">end_cycle</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">start_channel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">end_channel</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">pou</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">zplanes_n</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">overlap_percentage</span> <span class="o">=</span> <span class="mf">0.30</span>
<span class="n">workers</span> <span class="o">=</span> <span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span>
<span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Row coordinates: each row index is repeated m times</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
<span class="c1"># Column coordinates: snake pattern for each row, going back and forth from top left going right</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>

<span class="n">image_dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_dir</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stitch_dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">stitch_dir</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">zplanes_list</span> <span class="o">=</span><span class="p">[</span><span class="n">zplanes_n</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pou_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pou</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rows_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cols_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">overlap_percentage_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">overlap_percentage</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">use_gpu_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">use_gpu</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="n">total_operations</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_cycle</span> <span class="o">-</span> <span class="n">start_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">end_channel</span> <span class="o">-</span> <span class="n">start_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_operations</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;operation&#39;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{percentage:3.0f}</span><span class="s1">%|</span><span class="si">{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">]&#39;</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_cycle</span><span class="p">,</span> <span class="n">end_cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_channel</span><span class="p">,</span> <span class="n">end_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cycle </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> Channel </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">zplanes</span> <span class="o">=</span> <span class="n">zplanes_n</span><span class="o">//</span><span class="mi">2</span> 
            <span class="n">channels</span> <span class="o">=</span> <span class="n">display_jpeg</span>
            <span class="n">apply_KCorrect</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">stitch_dir</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="p">,</span> <span class="n">pou</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span>  <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                    <span class="n">cycles</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">zplanes</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">((</span><span class="n">zplanes_n</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
                    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">zplanes_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_KCorrect</span><span class="p">,</span> <span class="n">image_dir_list</span><span class="p">,</span> <span class="n">stitch_dir_list</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_list</span><span class="p">,</span> <span class="n">pou_list</span><span class="p">,</span> <span class="n">rows_list</span><span class="p">,</span> <span class="n">cols_list</span><span class="p">,</span> <span class="n">overlap_percentage_list</span><span class="p">,</span> <span class="n">use_gpu_list</span><span class="p">)</span> 

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "cd20c3863ded49bebfc70f51f83045c1"}</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">38</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="n">cycles</span> <span class="o">=</span> <span class="n">i</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="n">zplanes</span> <span class="o">=</span> <span class="n">zplanes_n</span><span class="o">//</span><span class="mi">2</span> 
<span class="ne">---&gt; </span><span class="mi">38</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">display_jpeg</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span> <span class="n">apply_KCorrect</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">stitch_dir</span><span class="p">,</span> <span class="n">zplanes</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">zplanes_n</span><span class="p">,</span> <span class="n">pou</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span>  <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;display_jpeg&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="deconvolution">
<h2>4. Deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>See the first notebook for information.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> 
                                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> 
                                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> 
                                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 

    <span class="n">rc</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">decon</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">stitch_dir</span><span class="p">,</span> <span class="n">dec_cycle</span><span class="p">,</span> <span class="n">dec_channel</span><span class="p">):</span>

    <span class="c1"># pixel size in xy dimension (nanometers)</span>
    <span class="n">xy_vox</span> <span class="o">=</span> <span class="mi">377</span>
    <span class="c1"># pixel size in z dimension (nanometers)</span>
    <span class="n">z_vox</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="c1"># Number of iterations of Lucy-Richardson algo before stopping unless stop_crit is met first</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="c1"># Microscope objective numerical aperture</span>
    <span class="n">mic_NA</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="c1"># Refractive index of tissue being imaged</span>
    <span class="n">tissue_RI</span> <span class="o">=</span> <span class="mf">1.44</span>
    <span class="c1"># Opening size in millimeters of objective aperture</span>
    <span class="n">slit_aper</span> <span class="o">=</span> <span class="mf">6.5</span>
    <span class="c1"># Focal length in millimeters of objective</span>
    <span class="n">f_cyl</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Used to reduce noise.  Increase value for noisy images. (0-10)</span>
    <span class="n">damping</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># If set, the deconvolved images will be clipped by this percent for max and min values, and then scaled to full range of bit depth. (0-5)</span>
    <span class="n">hist_clip</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="c1"># Percent change between iterations to use as criteria to stop deconvolution.</span>
    <span class="n">stop_criterion</span> <span class="o">=</span> <span class="mf">5.00</span>
    <span class="c1"># Percent maximum GPU or CPU memory </span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="c1"># Enter &#39;GPU&#39; or &#39;CPU&#39;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;GPU&#39;</span>
    <span class="c1"># Chunk size in bytes, or 1 for automatic chunking</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">3072</span>
    <span class="c1"># The respective excitation and emission wavelength in nanometers for each channel</span>
    <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">358</span><span class="p">,</span> <span class="mi">461</span><span class="p">),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">753</span><span class="p">,</span> <span class="mi">775</span><span class="p">),</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="mi">560</span><span class="p">,</span> <span class="mi">575</span><span class="p">),</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">648</span><span class="p">,</span> <span class="mi">668</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="n">decon_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_Decon&#39;</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_cycle</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="n">dec_channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decon_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_cycle</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="n">dec_channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">xy_vox</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_vox</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterations</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">mic_NA</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tissue_RI</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f_cyl</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">slit_aper</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">damping</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">hist_clip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">stop_criterion</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_memory</span><span class="p">),</span> <span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>

        <span class="n">decon_exe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;KDecon_v4.exe&quot;</span><span class="p">)</span> 
        <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">decon_exe</span><span class="p">)</span>
        <span class="n">ex_index</span><span class="p">,</span> <span class="n">em_index</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>

    <span class="k">if</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">:</span>

        <span class="n">mat_dir</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/MATLAB/MATLAB_Runtime/R2024a/&quot;</span> 
        <span class="n">decon_exe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;for_distribution_files_only&quot;</span><span class="p">,</span> <span class="s2">&quot;run_K_Decon_v4.sh&quot;</span><span class="p">)</span>
        <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">decon_exe</span><span class="p">)</span>
        <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mat_dir</span><span class="p">)</span>
        <span class="n">ex_index</span><span class="p">,</span> <span class="n">em_index</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span>

    <span class="n">ex</span><span class="p">,</span> <span class="n">em</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">[</span><span class="n">dec_channel</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ex_index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">em_index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">em</span><span class="p">))</span>

    <span class="n">run_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;deconvolved&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;deconvolved&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>To apply the above decon function to multiple cycles/channels, enter the start and end numbers below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decon_start_cycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">decon_end_cycle</span> <span class="o">=</span> <span class="mi">13</span>

<span class="n">decon_start_channel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">decon_end_channel</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">total_operations</span> <span class="o">=</span> <span class="p">(</span><span class="n">decon_end_cycle</span> <span class="o">-</span> <span class="n">decon_start_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">decon_end_channel</span> <span class="o">-</span> <span class="n">decon_start_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_operations</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;operation&#39;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{percentage:3.0f}</span><span class="s1">%|</span><span class="si">{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">]&#39;</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">decon_start_cycle</span><span class="p">,</span> <span class="n">decon_end_cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">decon_start_channel</span><span class="p">,</span> <span class="n">decon_end_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cycle </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> Channel </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">decon</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">stitch_dir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fiji-clij2-plugin-edf">
<h2>5. FIJI Clij2 plugin - EDF<a class="headerlink" href="#fiji-clij2-plugin-edf" title="Link to this heading">#</a></h2>
<p>See the previous notebook for information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiji_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;Fiji.app&quot;</span><span class="p">)</span>
<span class="n">javahome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21_windows-x64_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21.0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">javahome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
<span class="n">mavenhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9-bin&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mavenhome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>

<span class="n">ij_mem</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">scyjava</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-Xmx</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ij_mem</span><span class="p">)</span><span class="si">}</span><span class="s1">g&#39;</span><span class="p">)</span>
<span class="n">ij</span> <span class="o">=</span> <span class="n">imagej</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">fiji_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">platforms</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_platforms</span><span class="p">()</span>
<span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Device: </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Type: </span><span class="si">{</span><span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cpu_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">:</span>
            <span class="n">cpu_device</span> <span class="o">=</span> <span class="n">device</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">cpu_device</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">channel_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cyc01.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc02.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD31&quot;</span><span class="p">,</span> <span class="s2">&quot;CD8&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty2c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc03.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD20&quot;</span><span class="p">,</span> <span class="s2">&quot;Ki67&quot;</span><span class="p">,</span> <span class="s2">&quot;CD3e&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc04.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;SMActin&quot;</span><span class="p">,</span> <span class="s2">&quot;Podoplanin&quot;</span><span class="p">,</span> <span class="s2">&quot;CD68&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc05.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;PanCK&quot;</span><span class="p">,</span> <span class="s2">&quot;CD21&quot;</span><span class="p">,</span> <span class="s2">&quot;CD4&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc06.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Lyve1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45RO&quot;</span><span class="p">,</span> <span class="s2">&quot;CD11c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc07.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD35&quot;</span><span class="p">,</span> <span class="s2">&quot;ECAD&quot;</span><span class="p">,</span> <span class="s2">&quot;CD107a&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc08.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD34&quot;</span><span class="p">,</span> <span class="s2">&quot;CD44&quot;</span><span class="p">,</span> <span class="s2">&quot;HLADR&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc09.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty9a&quot;</span><span class="p">,</span> <span class="s2">&quot;FoxP3&quot;</span><span class="p">,</span> <span class="s2">&quot;CD163&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc10.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty10a&quot;</span><span class="p">,</span> <span class="s2">&quot;CollagenIV&quot;</span><span class="p">,</span> <span class="s2">&quot;Vimentin&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc11.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty11a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD15&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc12.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty12a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD5&quot;</span><span class="p">,</span> <span class="s2">&quot;CD1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc13.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13c&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">edf_start_cycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">edf_end_cycle</span> <span class="o">=</span> <span class="mi">13</span>

<span class="n">edf_start_channel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">edf_end_channel</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">decon_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_Decon&#39;</span><span class="p">)</span>
<span class="n">edf_dir</span> <span class="o">=</span> <span class="n">decon_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_Decon&#39;</span><span class="p">,</span> <span class="s1">&#39;_EDF&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;NVIDIA RTX A4500&quot;</span>

<span class="n">radius_x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">radius_y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">20.0</span>

<span class="n">xSplit</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ySplit</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">z_start</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">z_end</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">GPU</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">macro</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#@ File in_folder</span>
<span class="s2">#@ String device</span>
<span class="s2">#@ File out_folder</span>
<span class="s2">#@ String file_name</span>
<span class="s2">#@ Integer radius_x</span>
<span class="s2">#@ Integer radius_y</span>
<span class="s2">#@ Float sigma</span>
<span class="s2">#@ Integer xTiles</span>
<span class="s2">#@ Integer yTiles</span>
<span class="s2">#@ String z_start</span>
<span class="s2">#@ String z_end</span>
<span class="s2">#@ Boolean GPU</span>

<span class="s2">run(&quot;CLIJ2 Macro Extensions&quot;, &quot;cl_device=[&quot; + device + &quot;] automatic_output_naming=false&quot;);</span>
<span class="s2">Ext.CLIJ2_clear();</span>
<span class="s2">//setBatchMode(true);</span>

<span class="s2">File.openSequence(in_folder);</span>
<span class="s2">Stack.getDimensions(width, height, channels, slices, frames);</span>

<span class="s2">if (slices != z_end - z_start + 1) {</span>
<span class="s2">    run(&quot;Slice Keeper&quot;, &quot;first=&quot; + z_start + &quot; last=&quot; + z_end + &quot; increment=1&quot;);</span>
<span class="s2">    input = &quot;deconvolved kept stack&quot;;</span>
<span class="s2">    Stack.getDimensions(width, height, channels, slices, frames);</span>
<span class="s2">    } else {</span>
<span class="s2">    input = &quot;deconvolved&quot;;</span>
<span class="s2">}</span>

<span class="s2">if (GPU == true) {</span>
<span class="s2">	output = &quot;output&quot;;</span>
<span class="s2">	newImage(output, &quot;16-bit black&quot;, width, height, 1);</span>
<span class="s2">    } else {</span>
<span class="s2">    Ext.CLIJ2_push(input);</span>
<span class="s2">	Ext.CLIJ2_create2D(output, width, height, 16);</span>
<span class="s2">}</span>

<span class="s2">numTilesZ = 1;</span>
<span class="s2">numTilesX = xTiles;</span>
<span class="s2">numTilesY = yTiles;</span>

<span class="s2">tileDepth = round((slices/numTilesZ));</span>
<span class="s2">tileWidth = round((width/numTilesX));</span>
<span class="s2">tileHeight = round((height/numTilesY));</span>

<span class="s2">for (x = 0; x &lt; numTilesX; x++) {</span>
<span class="s2">	for (y = 0; y &lt; numTilesY; y++) {</span>
<span class="s2">		for (z = 0; z &lt; numTilesZ; z++) {</span>

<span class="s2">			Ext.CLIJ2_pushTile(input, x, y, z, tileWidth, tileHeight, tileDepth, 0, 0, 0);		</span>
<span class="s2">			Ext.CLIJ2_extendedDepthOfFocusVarianceProjection(input, output, radius_x, radius_y, sigma);</span>
<span class="s2">            Ext.CLIJ2_release(input);</span>
<span class="s2">            if (GPU == true) {</span>
<span class="s2">				Ext.CLIJ2_pullTile(output, x, y, z, tileWidth, tileHeight, 1, 0, 0, 0);</span>
<span class="s2">				Ext.CLIJ2_release(output);</span>
<span class="s2">			}            </span>
<span class="s2">		}</span>
<span class="s2">	}</span>
<span class="s2">}</span>

<span class="s2">if (GPU == false) {</span>
<span class="s2">	Ext.CLIJ2_pull(output);</span>
<span class="s2">    Ext.CLIJ2_release(output);</span>
<span class="s2">}</span>

<span class="s2">selectImage(output);</span>
<span class="s2">saveAs(&quot;Tiff&quot;, out_folder + File.separator + file_name);</span>

<span class="s2">Ext.CLIJ2_clear();</span>
<span class="s2">run(&quot;Close All&quot;);</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_operations</span> <span class="o">=</span> <span class="p">(</span><span class="n">edf_end_cycle</span> <span class="o">-</span> <span class="n">edf_start_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">edf_end_channel</span> <span class="o">-</span> <span class="n">edf_start_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_operations</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;operation&#39;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{percentage:3.0f}</span><span class="s1">%|</span><span class="si">{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">]&#39;</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edf_start_cycle</span><span class="p">,</span> <span class="n">edf_end_cycle</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">edf_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">edf_dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edf_start_channel</span><span class="p">,</span> <span class="n">edf_end_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cycle </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> Channel </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">edf_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decon_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;deconvolved&quot;</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">channel_name_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;in_folder&#39;</span><span class="p">:</span> <span class="n">edf_source</span><span class="p">,</span> 
                    <span class="s2">&quot;device&quot;</span> <span class="p">:</span> <span class="n">device</span><span class="p">,</span> 
                    <span class="s2">&quot;out_folder&quot;</span> <span class="p">:</span> <span class="n">edf_dest</span><span class="p">,</span> 
                    <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> 
                    <span class="s2">&quot;radius_x&quot;</span> <span class="p">:</span> <span class="n">radius_x</span><span class="p">,</span> 
                    <span class="s2">&quot;radius_y&quot;</span> <span class="p">:</span> <span class="n">radius_y</span><span class="p">,</span> 
                    <span class="s2">&quot;sigma&quot;</span> <span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> 
                    <span class="s2">&quot;xTiles&quot;</span> <span class="p">:</span> <span class="n">xSplit</span><span class="p">,</span> 
                    <span class="s2">&quot;yTiles&quot;</span> <span class="p">:</span> <span class="n">ySplit</span><span class="p">,</span> 
                    <span class="s2">&quot;z_start&quot;</span> <span class="p">:</span> <span class="n">z_start</span><span class="p">,</span> 
                    <span class="s2">&quot;z_end&quot;</span> <span class="p">:</span> <span class="n">z_end</span><span class="p">,</span> 
                    <span class="s2">&quot;GPU&quot;</span> <span class="p">:</span> <span class="n">GPU</span><span class="p">}</span>

            <span class="n">ij</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">run_macro</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "70c22c528377447e9286560908ad404e", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operating in headless mode - the original ImageJ will have limited functionality.
</pre></div>
</div>
</div>
</div>
</section>
<section id="registration">
<h2>6. Registration<a class="headerlink" href="#registration" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Registration is performed using the VALIS program <a class="reference external" href="https://valis.readthedocs.io/en/stable/examples.html">https://valis.readthedocs.io/en/stable/examples.html</a>.</p></li>
<li><p>In the following cell, the images produced in Section 5 are combined to multi-channel tif files in a format the VALIS program is compatible with.</p></li>
<li><p>Enter the cycles being processed, the data_type desired, and the pixel size.</p></li>
<li><p>The metadata and parameters for pyramidal output may be changed.</p></li>
<li><p>Be sure the path to the vips binaries is defined correctly.</p></li>
</ul>
<section id="combine-channels-for-each-cycle">
<h3>6.1 Combine channels for each cycle<a class="headerlink" href="#combine-channels-for-each-cycle" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_start_cycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">reg_end_cycle</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;uint16&quot;</span>  
<span class="n">pixel_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.377</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span> <span class="c1">#change to INFO for more details</span>

<span class="k">if</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="n">vipshome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span><span class="s1">&#39;vips-dev-8.16&#39;</span><span class="p">,</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vipshome</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">pyvips</span> 

<span class="n">edf_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_EDF&#39;</span><span class="p">)</span>
<span class="n">reg_dir</span> <span class="o">=</span> <span class="n">edf_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_EDF&#39;</span><span class="p">,</span> <span class="s1">&#39;_Registration&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pbar_filesave</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Percent&quot;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">]&#39;</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reg_start_cycle</span><span class="p">,</span> <span class="n">reg_end_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">cycle</span><span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> 
     
    <span class="n">reg_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
    <span class="n">image_set</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_source</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span><span class="p">))</span>
    <span class="n">channel_name_order</span> <span class="o">=</span> <span class="n">channel_name_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
    <span class="n">image_set</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">channel_name_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
  
    <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_set</span><span class="p">)):</span>
        <span class="n">split_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">channel_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split_name</span><span class="p">)</span>
 
    <span class="n">pyvips_image_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_source</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">access</span><span class="o">=</span><span class="s2">&quot;sequential&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">image_set</span><span class="p">]</span>

    <span class="n">out_init</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">arrayjoin</span><span class="p">(</span><span class="n">pyvips_image_set</span><span class="p">,</span> <span class="n">across</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">out</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">GValue</span><span class="o">.</span><span class="n">gint_type</span><span class="p">,</span> <span class="s2">&quot;page-height&quot;</span><span class="p">,</span> <span class="n">pyvips_image_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="n">x_dim</span> <span class="o">=</span> <span class="n">pyvips_image_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
    <span class="n">y_dim</span> <span class="o">=</span> <span class="n">pyvips_image_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pyvips_image_set</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">.ome.tif&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">GValue</span><span class="o">.</span><span class="n">gstr_type</span><span class="p">,</span> <span class="s2">&quot;image-description&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s2">        &lt;OME xmlns=&quot;http://www.openmicroscopy.org/Schemas/OME/2016-06&quot;</span>
<span class="s2">            xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="s2">            xsi:schemaLocation=&quot;http://www.openmicroscopy.org/Schemas/OME/2016-06 http://www.openmicroscopy.org/Schemas/OME/2016-06/ome.xsd&quot;&gt;</span>
<span class="s2">            &lt;Image ID=&quot;Image:0&quot; Name=&quot;</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot; &gt;</span>
<span class="s2">                &lt;!-- Minimum required fields about image dimensions --&gt;</span>
<span class="s2">                &lt;Pixels BigEndian=&quot;false&quot;</span>
<span class="s2">                        DimensionOrder=&quot;XYCZT&quot; </span>
<span class="s2">                        ID=&quot;Pixels:0&quot;</span>
<span class="s2">                        Interleaved=&quot;false&quot;</span>
<span class="s2">                        SignificantBits=&quot;16&quot;                                              </span>
<span class="s2">                        SizeC=&quot;</span><span class="si">{</span><span class="n">bands</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">                        SizeT=&quot;1&quot; </span>
<span class="s2">                        SizeX=&quot;</span><span class="si">{</span><span class="n">x_dim</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">                        SizeY=&quot;</span><span class="si">{</span><span class="n">y_dim</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">                        SizeZ=&quot;1&quot; </span>
<span class="s2">                        Type=&quot;</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">                        PhysicalSizeX=&quot;</span><span class="si">{</span><span class="n">pixel_size</span><span class="si">}</span><span class="s2">&quot; </span>
<span class="s2">                        PhysicalSizeY=&quot;</span><span class="si">{</span><span class="n">pixel_size</span><span class="si">}</span><span class="s2">&quot;&gt;</span>
<span class="s2">                    &lt;TiffData FirstC=&quot;0&quot; FirstT=&quot;0&quot; FirstZ=&quot;0&quot; IFD=&quot;0&quot; PlaneCount=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;Channel Color=&quot;16751615&quot; ID=&quot;Channel:0:0&quot; Name=&quot;</span><span class="si">{</span><span class="n">channel_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; IlluminationType=&quot;Epifluorescence&quot; ContrastMethod=&quot;Fluorescence&quot; AcquisitionMode=&quot;WideField&quot; SamplesPerPixel=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;TiffData FirstC=&quot;1&quot; FirstT=&quot;0&quot; FirstZ=&quot;0&quot; IFD=&quot;1&quot; PlaneCount=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;Channel Color=&quot;7995391&quot; ID=&quot;Channel:0:1&quot; Name=&quot;</span><span class="si">{</span><span class="n">channel_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; IlluminationType=&quot;Epifluorescence&quot; ContrastMethod=&quot;Fluorescence&quot; AcquisitionMode=&quot;WideField&quot; SamplesPerPixel=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;TiffData FirstC=&quot;2&quot; FirstT=&quot;0&quot; FirstZ=&quot;0&quot; IFD=&quot;2&quot; PlaneCount=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;Channel Color=&quot;9043967&quot; ID=&quot;Channel:0:2&quot; Name=&quot;</span><span class="si">{</span><span class="n">channel_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; IlluminationType=&quot;Epifluorescence&quot; ContrastMethod=&quot;Fluorescence&quot; AcquisitionMode=&quot;WideField&quot; SamplesPerPixel=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;TiffData FirstC=&quot;3&quot; FirstT=&quot;0&quot; FirstZ=&quot;0&quot; IFD=&quot;3&quot; PlaneCount=&quot;1&quot;/&gt;</span>
<span class="s2">                    &lt;Channel Color=&quot;1828651263&quot; ID=&quot;Channel:0:3&quot; Name=&quot;</span><span class="si">{</span><span class="n">channel_names</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; IlluminationType=&quot;Epifluorescence&quot; ContrastMethod=&quot;Fluorescence&quot; AcquisitionMode=&quot;WideField&quot; SamplesPerPixel=&quot;1&quot;/&gt;</span>
<span class="s2">                &lt;/Pixels&gt;</span>
<span class="s2">            &lt;/Image&gt;</span>
<span class="s2">        &lt;/OME&gt;&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">out</span><span class="o">.</span><span class="n">tiffsave</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">page_height</span><span class="o">=</span><span class="n">y_dim</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;lzw&#39;</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">tile_width</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">tile_height</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bigtiff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pyvips_image_set</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> 
    <span class="n">pbar_filesave</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">reg_end_cycle</span> <span class="o">-</span> <span class="n">reg_start_cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">pbar_filesave</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="valis-registration">
<h3>6.2 VALIS Registration<a class="headerlink" href="#valis-registration" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>See <a class="github reference external" href="https://github.com/MathOnco/valis/tree/main">MathOnco/valis</a> for full documentation.
The process for registration involves producing registration data on the rigid and non-rigid movement of the images relative to one another to bring about alignment as they overlap.  This data is inspected for accuracy as the writing of the registered images takes a long time.  There is an optional micro-registration if smaller structure overlap is important.  Either way, the registration results to be used for the image registration is stored in the results_dst_dir as a .pickle file.</p></li>
<li><p>According to the VALIS docs: One of the most important parameters used to initialize a Valis object is max_processed_image_dim_px, which determines the size of the image used to find the rigid registration parameters. The default value is 850, but if registration fails or is poor, try adjusting that value. Generally speaking, values between 500-2000 work well. In cases where there is little empty space around the tissue, smaller values may be better. However, if there is a large amount of empty space/slide (as in the images above), larger values may be needed so that the tissue is at a high enough resolution. To improve alignment of the finer details in the images, larger images can be used in the non-rigid or micro-registration steps (set via the max_non_rigid_registration_dim_px parameter).</p></li>
<li><p>If you get an error that the jvm is not found, try uncommenting the registration.init_jvm() line.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
<span class="k">if</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="n">vipsbin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span><span class="s1">&#39;vips-dev-8.16&#39;</span><span class="p">,</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vipsbin</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
<span class="n">javahome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21_windows-x64_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21.0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">javahome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>

<span class="n">mavenhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9-bin&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mavenhome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1"># registration.init_jvm()</span>

<span class="n">edf_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_EDF&#39;</span><span class="p">)</span>
<span class="n">reg_dir</span> <span class="o">=</span> <span class="n">edf_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_EDF&#39;</span><span class="p">,</span> <span class="s1">&#39;_Registration&#39;</span><span class="p">)</span>

<span class="n">slide_src_dir</span> <span class="o">=</span> <span class="n">reg_dir</span>
<span class="n">results_dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Running this cell will produce registration data, but will not register the images, allowing for testing different parameters.</p></li>
<li><p>Note that if you rerun the registration, results will be overwritten.  To avoid this you will need to rename your results_dst_dir folder.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_processed_image_dim_px</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">Valis</span><span class="p">(</span><span class="n">slide_src_dir</span><span class="p">,</span> <span class="n">results_dst_dir</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="n">max_processed_image_dim_px</span> <span class="o">=</span> <span class="n">max_processed_image_dim_px</span><span class="p">,</span> <span class="n">imgs_ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">non_rigid_registrar</span><span class="p">,</span> <span class="n">error_df</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Review the results in the produced registration folder saved in valis_out</p></li>
<li><p>A quick method is to scroll through the deformation_fields images below.  Be cautious of angular deformations.  Other options to view by replacing deformation_fields below: masks, non_rigid_registration, processed, and rigid_registration.</p></li>
<li><p>To view the output, you may need to click the ellipses next to the output cell and click Change Presentation to choose IPyWidgetRenderer.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Other options to view by replacing &quot;deformation_fields&quot; below: &quot;masks&quot;, &quot;non_rigid_registration&quot;, &quot;processed&quot;, and &quot;rigid_registration&quot;.</span>
<span class="n">im_raw_deform</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">),</span> <span class="s2">&quot;deformation_fields&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
<span class="n">im_deform</span> <span class="o">=</span> <span class="n">imread_collection</span><span class="p">(</span><span class="n">im_raw_deform</span><span class="p">)</span>
<span class="n">deform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im_deform</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="n">stackview</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">deform</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">continuous_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Micro-registration takes much longer (e.g. standard ~5-10 min and micro ~2-3 hrs) than standard registration.  Be sure to test a few changes to the standard method before switching to micro.</p></li>
<li><p>If further refining of results is warranted, the optional micro-registration may be run.</p></li>
<li><p>Note that the previous registration is saved to the .pickle file in path_to_register.  This will be overwritten by the micro-registration results.  To avoid this, rename the .pickle file.</p></li>
<li><p>The cell below determines the parameter to use based on 25% of original resolution.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">micro_reg_fraction</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">img_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slide_obj</span><span class="o">.</span><span class="n">slide_dimensions_wh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">slide_obj</span> <span class="ow">in</span> <span class="n">registrar</span><span class="o">.</span><span class="n">slide_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">img_dims</span><span class="p">)</span>
<span class="n">min_max_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">img_dims</span><span class="p">])</span>
<span class="n">img_areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">img_dims</span><span class="p">]</span>
<span class="n">max_img_w</span><span class="p">,</span> <span class="n">max_img_h</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">img_dims</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img_areas</span><span class="p">)])</span>
<span class="n">micro_reg_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">min_max_size</span><span class="o">*</span><span class="n">micro_reg_fraction</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valis.micro_rigid_registrar</span> <span class="kn">import</span> <span class="n">MicroRigidRegistrar</span>

<span class="n">micro_results_dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out_micro&quot;</span><span class="p">)</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">Valis</span><span class="p">(</span><span class="n">slide_src_dir</span><span class="p">,</span> <span class="n">micro_results_dst_dir</span><span class="p">,</span> <span class="n">micro_rigid_registrar_cls</span><span class="o">=</span><span class="n">MicroRigidRegistrar</span><span class="p">)</span>
<span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">non_rigid_registrar</span><span class="p">,</span> <span class="n">error_df</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">micro_reg</span><span class="p">,</span> <span class="n">micro_error</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register_micro</span><span class="p">(</span><span class="n">max_non_rigid_registration_dim_px</span><span class="o">=</span><span class="n">micro_reg_size</span><span class="p">)</span>
<span class="n">matches_dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">registrar</span><span class="o">.</span><span class="n">dst_dir</span><span class="p">,</span> <span class="s2">&quot;hi_rez_matches&quot;</span><span class="p">)</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">draw_matches</span><span class="p">(</span><span class="n">matches_dst_dir</span><span class="p">)</span>
<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Review the results of micro-registration.</p></li>
<li><p>New output will be for deformation_fields, micro_registration, non_rigid_registration, overlaps, and hi_rez_matches.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im_raw_micro</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">),</span> <span class="s2">&quot;deformation_fields&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
<span class="n">im_micro</span> <span class="o">=</span> <span class="n">imread_collection</span><span class="p">(</span><span class="n">im_raw_micro</span><span class="p">)</span>
<span class="n">micro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im_micro</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="n">stackview</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">micro</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">continuous_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is where the application of the registration to the images occurs.  The first cell merges all images to one file, while the second creates one image per cycle. If multiple rounds of testing was done, be sure you are using the final .pickle file for the final image creation.</p>
<ul class="simple">
<li><p>At this point, images are likely not the same size.  Using the crop function will crop all images to the same size.  This is necessary to use image math functions in the next notebook.</p></li>
<li><p>Naming is based on the definitions of channel_name_dict defined above.  It may be necessary to run that cell again.</p></li>
<li><p>The registration of the common first channel will effectively align the rest of the channels in each cycle to one another.</p></li>
<li><p>Note that writting large image files generally takes a long time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">channel_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cyc01.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc02.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD31&quot;</span><span class="p">,</span> <span class="s2">&quot;CD8&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty2c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc03.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD20&quot;</span><span class="p">,</span> <span class="s2">&quot;Ki67&quot;</span><span class="p">,</span> <span class="s2">&quot;CD3e&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc04.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;SMActin&quot;</span><span class="p">,</span> <span class="s2">&quot;Podoplanin&quot;</span><span class="p">,</span> <span class="s2">&quot;CD68&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc05.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;PanCK&quot;</span><span class="p">,</span> <span class="s2">&quot;CD21&quot;</span><span class="p">,</span> <span class="s2">&quot;CD4&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc06.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Lyve1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45RO&quot;</span><span class="p">,</span> <span class="s2">&quot;CD11c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc07.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD35&quot;</span><span class="p">,</span> <span class="s2">&quot;ECAD&quot;</span><span class="p">,</span> <span class="s2">&quot;CD107a&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc08.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD34&quot;</span><span class="p">,</span> <span class="s2">&quot;CD44&quot;</span><span class="p">,</span> <span class="s2">&quot;HLADR&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc09.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty9a&quot;</span><span class="p">,</span> <span class="s2">&quot;FoxP3&quot;</span><span class="p">,</span> <span class="s2">&quot;CD163&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc10.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty10a&quot;</span><span class="p">,</span> <span class="s2">&quot;CollagenIV&quot;</span><span class="p">,</span> <span class="s2">&quot;Vimentin&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc11.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty11a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD15&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc12.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty12a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD5&quot;</span><span class="p">,</span> <span class="s2">&quot;CD1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc13.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13c&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">merged_slide_dst_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_dst_dir</span><span class="p">,</span> <span class="s2">&quot;merged.ome.tif&quot;</span><span class="p">)</span>
<span class="n">path_to_registrar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">),</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_registrar.pickle&quot;</span><span class="p">)</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">load_registrar</span><span class="p">(</span><span class="n">path_to_registrar</span><span class="p">)</span>

<span class="n">merged_img</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">,</span> <span class="n">ome_xml</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">warp_and_merge_slide</span><span class="p">(</span><span class="n">merged_slide_dst_f</span><span class="p">,</span>
                                    <span class="n">crop</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span>
                                    <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                    <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;jp2k&quot;</span><span class="p">,</span>
                                    <span class="n">Q</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                    <span class="n">pyramid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_to_registrar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;valis_out&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">),</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_registrar.pickle&quot;</span><span class="p">)</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">load_registrar</span><span class="p">(</span><span class="n">path_to_registrar</span><span class="p">)</span>

<span class="k">for</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">slide_obj</span> <span class="ow">in</span> <span class="n">registrar</span><span class="o">.</span><span class="n">slide_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">reg_dir_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">,</span> <span class="s2">&quot;registered&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">reg_dir_out</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dst_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg_dir_out</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slide_name</span><span class="si">}</span><span class="s2">.ome.tif&quot;</span><span class="p">)</span>
    <span class="n">slide_obj</span><span class="o">.</span><span class="n">warp_and_save_slide</span><span class="p">(</span><span class="n">dst_f</span><span class="o">=</span><span class="n">dst_f</span><span class="p">,</span> 
                                  <span class="n">crop</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span>                                  
                                  <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;jp2k&quot;</span><span class="p">,</span> 
                                  <span class="n">Q</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                  <span class="n">pyramid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./src\notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="1_Single_Channel_Eval.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Part 1: Explore data, test and tune processing parameters.</p>
      </div>
    </a>
    <a class="right-next"
       href="3_Signal_Isolation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Part 3: Isolate signal from autofluorescence and noise.</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching-and-illumination-correction">3. Stitching and Illumination Correction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching-function">3.1 Stitching Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#illumination-correction-function">3.2 Illumination Correction Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-multiple-cycle-channel-combinations">3.3 Running Multiple Cycle/Channel Combinations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">4. Deconvolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiji-clij2-plugin-edf">5. FIJI Clij2 plugin - EDF</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#registration">6. Registration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-channels-for-each-cycle">6.1 Combine channels for each cycle</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#valis-registration">6.2 VALIS Registration</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Justin Smith
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>