
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Part 1: Explore data, test and tune processing parameters. &#8212; KINTSUGI</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'src/notebooks/1_Single_Channel_Eval';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Part 2: Batch Process" href="2_Cycle_Processing.html" />
    <link rel="prev" title="Installation Steps" href="../../Installation%20Steps.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../Intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cluster.gif" class="logo__image only-light" alt="KINTSUGI - Home"/>
    <img src="../../_static/cluster.gif" class="logo__image only-dark pst-js-only" alt="KINTSUGI - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../Intro.html">
                    KINTSUGI: Knowledge Integration with New Technologies for Simplified User-Guided Image processing
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Installation%20Steps.html">Installation Steps</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Part 1: Explore data, test and tune processing parameters.</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Cycle_Processing.html">Part 2: Batch Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Signal_Isolation.html">Part 3: Isolate signal from autofluorescence and noise.</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Segmentation.html">Part 4: Segment cells and nuclei.</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_Cluster_Pixels.html">Part 5: Cluster pixels.</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_Cluster_Cells.html">Part 6: Cluster cells.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI/issues/new?title=Issue%20on%20page%20%2Fsrc/notebooks/1_Single_Channel_Eval.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/src/notebooks/1_Single_Channel_Eval.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Part 1: Explore data, test and tune processing parameters.</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-the-following-notebook-you-will-prepare-for-processing-your-images-test-illumination-correction-parameters-stitching-accuracy-and-deconvolution">In the following notebook you will prepare for processing your images; test illumination correction parameters, stitching accuracy, and deconvolution.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">*This must be done every time the notebook is started or restarted.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-method-a">2.1a Method A</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-method-b">2.1b Method B</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shorten-cycle-folder-names">2.2 Shorten cycle folder names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-test-set">2.4 Import test set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#illumination-correction">3. Illumination Correction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downsize-and-resize">3.1 Downsize and resize.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#take-mean-and-transform">3.2 Take Mean and Transform</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">3.3 Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-correction">3.4 Estimate Correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-to-data">3.5 Apply to Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching">4. Stitching</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-stitching-positions-and-save-model">4.1 Find Stitching Positions and Save Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-4-2">Section 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-4-3">Section 4.3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">5. Deconvolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiji-clij2-plugin-edf">6. FIJI Clij2 plugin - EDF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-fiji-variables">6.1 Define FIJI variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-device-names">6.2 Get Device Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-channel-names">6.3 Define Channel Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-edf">6.4 Run EDF</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="part-1-explore-data-test-and-tune-processing-parameters">
<h1>Part 1: Explore data, test and tune processing parameters.<a class="headerlink" href="#part-1-explore-data-test-and-tune-processing-parameters" title="Link to this heading">#</a></h1>
<section id="in-the-following-notebook-you-will-prepare-for-processing-your-images-test-illumination-correction-parameters-stitching-accuracy-and-deconvolution">
<h2>In the following notebook you will prepare for processing your images; test illumination correction parameters, stitching accuracy, and deconvolution.<a class="headerlink" href="#in-the-following-notebook-you-will-prepare-for-processing-your-images-test-illumination-correction-parameters-stitching-accuracy-and-deconvolution" title="Link to this heading">#</a></h2>
</section>
<section id="import-packages">
<h2>1. Import packages.<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h2>
<section id="this-must-be-done-every-time-the-notebook-is-started-or-restarted">
<h3>*This must be done every time the notebook is started or restarted.<a class="headerlink" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted" title="Link to this heading">#</a></h3>
<p>Run cells using Ctrl+Enter or by pressing the play (triangle) button.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">simpledialog</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">Kstitch.stitching</span> <span class="kn">import</span> <span class="n">stitch_images</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">skimage.io.collection</span> <span class="kn">import</span> <span class="n">alphanumeric_key</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread</span> 
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imsave</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">imagej</span><span class="o">,</span> <span class="nn">scyjava</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span> <span class="k">as</span> <span class="n">skresize</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">dct</span><span class="p">,</span> <span class="n">idct</span>
<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="k">as</span> <span class="nn">cl</span>
<span class="n">os_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
<span class="n">current_dateTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="define-directory-paths">
<h2>2. Define directory paths.<a class="headerlink" href="#define-directory-paths" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>*This must be done every time the notebook is started or restarted.<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>If you are familiar with defining directories, enter them below.  If not, the other cells will assist with the necessary definitions.</p></li>
<li><p>If you have established the directories with Method B, from now on use Method A by copying the directories in their respective variable names.</p></li>
</ul>
</section>
<section id="a-method-a">
<h3>2.1a Method A<a class="headerlink" href="#a-method-a" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">smith6jt&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;1904_CC2B_raw&#39;</span><span class="p">)</span>
<span class="n">stitch_dir</span> <span class="o">=</span> <span class="n">image_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;_BaSiC_Stitched&quot;</span><span class="p">)</span>
<span class="n">meta_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_BaSiC_Stitched&quot;</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">)</span>
<span class="n">project_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;project_data.txt&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image folder is </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stitching folder is </span><span class="si">{</span><span class="n">stitch_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Meta folder is </span><span class="si">{</span><span class="n">meta_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_raw.
Stitching folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_BaSiC_Stitched.
Meta folder is C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_meta.
</pre></div>
</div>
</div>
</div>
</section>
<section id="b-method-b">
<h3>2.1b Method B<a class="headerlink" href="#b-method-b" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>First, assess the folder and file names.  For example, in CODEX output, the original folder name is something like CX_20-008_SP_CC2-B. We can shorten that now to make life easier down the road.  Shorten the folder name to remove redundant information.  In this example we choose “2008_CC2B_raw” making sure the ‘_raw’ is the last part.</p></li>
<li><p>Running the following cell will bring up a dialog window where you will enter the new folder name and select the folder containing your images.  In the folder you select, make sure there are only a series of folders containing the images for each cycle.</p></li>
<li><p>This folder will be renamed and designated as “image_dir” for the project.  A stitching output folder and a folder for metadata files will also be created.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
<span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>

<span class="n">user_choice</span> <span class="o">=</span> <span class="n">simpledialog</span><span class="o">.</span><span class="n">askstring</span><span class="p">(</span><span class="s2">&quot;Shortened name&quot;</span><span class="p">,</span> <span class="s2">&quot;Enter shortened file name with _raw at end&quot;</span><span class="p">)</span>
<span class="n">image_dir_long</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askdirectory</span><span class="p">()</span>
<span class="n">head_dir</span><span class="p">,</span> <span class="n">tail_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">image_dir_long</span><span class="p">)</span>
<span class="n">base_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">head_dir</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>  
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">image_dir_long</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head_dir</span><span class="p">,</span> <span class="n">user_choice</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file or directory does not exist.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;you don&#39;t have permissions to rename the file&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head_dir</span><span class="p">,</span> <span class="n">user_choice</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head_dir</span><span class="p">,</span> <span class="n">user_choice</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_dir_long</span><span class="si">}</span><span class="s2"> renamed to </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in renaming.&quot;</span><span class="p">)</span>
    
<span class="n">stitch_dir</span> <span class="o">=</span> <span class="n">image_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">)</span>
<span class="n">meta_dir</span> <span class="o">=</span> <span class="n">image_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stitching output folder: </span><span class="si">{</span><span class="n">stitch_dir</span><span class="si">}</span><span class="s2"> created successfully.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stitching output folder not created.&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata folder: </span><span class="si">{</span><span class="n">meta_dir</span><span class="si">}</span><span class="s2"> created successfully.  Move metadata files to metadata folder.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata folder not created.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">head_dir</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="k">try</span><span class="p">:</span>  
<span class="ne">---&gt; </span><span class="mi">10</span>     <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">image_dir_long</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head_dir</span><span class="p">,</span> <span class="n">user_choice</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file or directory does not exist.&quot;</span><span class="p">)</span>

<span class="nn">File ~\miniforge3\envs\KINTSUGI\lib\ntpath.py:117,</span> in <span class="ni">join</span><span class="nt">(path, *paths)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="k">return</span> <span class="n">result_drive</span> <span class="o">+</span> <span class="n">result_path</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span> <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">BytesWarning</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">117</span>     <span class="n">genericpath</span><span class="o">.</span><span class="n">_check_arg_types</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="k">raise</span>

<span class="nn">File ~\miniforge3\envs\KINTSUGI\lib\genericpath.py:152,</span> in <span class="ni">_check_arg_types</span><span class="nt">(funcname, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">150</span>         <span class="n">hasbytes</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">152</span>         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">funcname</span><span class="si">}</span><span class="s1">() argument must be str, bytes, or &#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">153</span>                         <span class="sa">f</span><span class="s1">&#39;os.PathLike object, not </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span> <span class="k">if</span> <span class="n">hasstr</span> <span class="ow">and</span> <span class="n">hasbytes</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span>     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t mix strings and bytes in path components&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

<span class="ne">TypeError</span>: join() argument must be str, bytes, or os.PathLike object, not &#39;NoneType&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="shorten-cycle-folder-names">
<h3>2.2 Shorten cycle folder names<a class="headerlink" href="#shorten-cycle-folder-names" title="Link to this heading">#</a></h3>
<p>NOTE: Running this cell permanently alters the cycle folder names.  This only needs to be done once.</p>
<ul class="simple">
<li><p>If the cycle folders have long names starting with the cycle numbers followed by a split character (e.g. the underscore in ‘cyc001_reg001_200210_170925’) this cell will shorten the folder name to everything before the first split character.</p></li>
<li><p>Enter the split character in quotations.  It is usually an underscore.</p></li>
<li><p>Note that the rest of the folder name will be deleted unless you add additional arguments to the os.rename function.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rename long source folder names</span>

<span class="n">split_character</span> <span class="o">=</span> <span class="n">simpledialog</span><span class="o">.</span><span class="n">askstring</span><span class="p">(</span><span class="s2">&quot;Split character&quot;</span><span class="p">,</span> <span class="s2">&quot;Enter split character&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split character is </span><span class="si">{</span><span class="n">split_character</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">split_character</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No input given.&#39;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">cyc_folder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">cyc_folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_character</span><span class="p">)</span>
        <span class="n">cycle_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">cyc_folder</span><span class="p">)</span>
        <span class="n">cycle_dir_short</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">cycle_dir</span><span class="p">,</span> <span class="n">cycle_dir_short</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cycle_dir_short</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cycle_dir</span><span class="si">}</span><span class="s2"> renamed to </span><span class="si">{</span><span class="n">cycle_dir_short</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Processing very large image datasets takes considerable time.  To avoid having to repeat the process and to use the most efficient processing methods, the rest of this notebook allows for the discovery and tuning of parameters for each step.</p></li>
<li><p>First choose and inspect a single z-plane of a single cycle/channel combination, and check the quality of illumination correction and stitching.  Then you will work with an entire stack to assess deconvolution and extended depth of focus (EDF).</p></li>
<li><p>Starting with the nuclear staining channel or other channels necessary for segmentation is a good idea.</p></li>
<li><p>Make sure to assess channels with differing staining patterns and intensities.</p></li>
<li><p>Enter the z-plane, channel number, and pattern of the image_file name below.  The wildcard characters “??” are entered where the image tile numbers are so that all tiles are loaded.</p></li>
<li><p>The cycle folder names are assumed to have been shortened and in the format “cyc00x”.  Running the cell will prompt to enter the cycle folder of interest or you may comment out the first line and uncomment the second where your folder is defined.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cycle_folder = filedialog.askdirectory()</span>
<span class="n">cycle_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;cyc001&quot;</span><span class="p">)</span>

<span class="n">zplane</span> <span class="o">=</span> <span class="mi">8</span> 
<span class="n">channel</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># image_file name below is derived from 1_000tt_Z0zz_CHc.tif where tt is the tile number with one leading zero, zz is the z-position with one leading zero, and c is the channel number.</span>
<span class="n">image_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;1_000??_Z0</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">zplane</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">_CH</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.tif&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">cycle_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">image_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using C:\Users\smith6jt\KINTSUGI\data\1904_CC2B_raw\cyc001/1_000??_Z008_CH2.tif
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-test-set">
<h3>2.4 Import test set<a class="headerlink" href="#import-test-set" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im_raw</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle_folder</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">alphanumeric_key</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">im_raw</span><span class="p">)</span>
<span class="n">im_array_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image shape is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image shape is (63, 1440, 1920) and type is uint16
Min value is 0 and max value is 4855
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="illumination-correction">
<h2>3. Illumination Correction<a class="headerlink" href="#illumination-correction" title="Link to this heading">#</a></h2>
<section id="downsize-and-resize">
<h3>3.1 Downsize and resize.<a class="headerlink" href="#downsize-and-resize" title="Link to this heading">#</a></h3>
<p>Define the function to resize the images to a smaller and square dimension for estimating the uneven illumination.  Usually no changes need to be made here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESIZE_ORDER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">RESIZE_MODE</span> <span class="o">=</span> <span class="s2">&quot;symmetric&quot;</span>
<span class="n">PRESERVE_RANGE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">OUTPUT_IMAGE</span> <span class="o">=</span> <span class="s2">&quot;OutputImage&quot;</span>

<span class="k">def</span> <span class="nf">_resize_images_list</span><span class="p">(</span><span class="n">images_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">side_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_side_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_side_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">side_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_side_size</span> <span class="o">=</span> <span class="n">x_side_size</span> <span class="o">=</span> <span class="n">side_size</span>
    <span class="n">resized_images_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x_side_size</span> <span class="ow">or</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y_side_size</span><span class="p">:</span>
            <span class="n">resized_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skresize</span><span class="p">(</span>
                <span class="n">im</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">x_side_size</span><span class="p">,</span> <span class="n">y_side_size</span><span class="p">),</span> 
                <span class="n">order</span> <span class="o">=</span> <span class="n">RESIZE_ORDER</span><span class="p">,</span> 
                <span class="n">mode</span> <span class="o">=</span> <span class="n">RESIZE_MODE</span><span class="p">,</span>
                <span class="n">preserve_range</span> <span class="o">=</span> <span class="n">PRESERVE_RANGE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resized_images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resized_images_list</span>
</pre></div>
</div>
</div>
</div>
<p>Run the resize function and prints out some information about the images.  Usually no changes need to be made here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_saved_size</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="n">working_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">working_size</span>

<span class="n">downsized_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">_resize_images_list</span><span class="p">(</span><span class="n">images_list</span><span class="o">=</span><span class="n">im</span><span class="p">,</span> <span class="n">side_size</span><span class="o">=</span><span class="n">working_size</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downsized image shape is </span><span class="si">{</span><span class="n">downsized_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">downsized_image</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">downsized_image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">downsized_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downsized image shape is (128, 128, 63) and type is float64
Min value is 100.11630717478822 and max value is 2771.1888579166134
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plot the original image and histogram next to the resized image and histogram.</p></li>
<li><p>Enter a number for “i” that is within the range of the number of images in your dataset for one channel.</p></li>
<li><p>For this and the rest of the image/histogram cells, you can adjust the size of the plot by entering values for “figsize.”</p></li>
<li><p>You can also change the colors of the images by changing “cmap.”</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">downsized_image</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">downsized_image</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Downsized Image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5f3f671109d857c8abe30f86bf17dd360c2a100194618d342cf0158bdc690952.png" src="../../_images/5f3f671109d857c8abe30f86bf17dd360c2a100194618d342cf0158bdc690952.png" />
</div>
</div>
</section>
<section id="take-mean-and-transform">
<h3>3.2 Take Mean and Transform<a class="headerlink" href="#take-mean-and-transform" title="Link to this heading">#</a></h3>
<p>This cell takes the average of all the image tiles and standardizes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">downsized_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mean_div</span> <span class="o">=</span> <span class="n">mean_image</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>View the mean and standardized images as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">mean_image</span><span class="p">)</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">mean_div</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Downsized image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_div</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean of downsized images&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/184f5bb4203fad718d711af5d7373dd37fe58c9f2713895bab25854306649ecb.png" src="../../_images/184f5bb4203fad718d711af5d7373dd37fe58c9f2713895bab25854306649ecb.png" />
</div>
</div>
<p>This cell defines the function to to calculate a compressed representation of the image data and the next cells runs the function and allow for visualization as before.  Usually no changes need to be made here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_dct2d</span><span class="p">(</span><span class="n">mtrx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates 2D discrete cosine transform.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mtrx</span>
<span class="sd">        Input matrix.  </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------    </span>
<span class="sd">    Discrete cosine transform of the input matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
     
    <span class="c1"># Check if input object is 2D.</span>
    <span class="k">if</span> <span class="n">mtrx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passed object should be a matrix or a numpy array with dimension of two.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dct</span><span class="p">(</span><span class="n">dct</span><span class="p">(</span><span class="n">mtrx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dis_Cos_Trans_mean</span> <span class="o">=</span> <span class="n">_dct2d</span><span class="p">(</span><span class="n">mean_div</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">mean_div</span><span class="p">)</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">Dis_Cos_Trans_mean</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_div</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean Image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Dis_Cos_Trans_mean</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Discrete Cosine </span><span class="se">\n</span><span class="s1">Transform of Mean Image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5bb3cbf58727bf855e09a596695ee1cd8ce59fc27f4e7bdcd9549dbea9d32f60.png" src="../../_images/5bb3cbf58727bf855e09a596695ee1cd8ce59fc27f4e7bdcd9549dbea9d32f60.png" />
</div>
</div>
</section>
<section id="functions">
<h3>3.3 Functions<a class="headerlink" href="#functions" title="Link to this heading">#</a></h3>
<p>This cell defines functions to inverse the dct function, estimate the illumination correction, and resize the images to their original shape.  Usually no changes need to be made here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_idct2d</span><span class="p">(</span><span class="n">mtrx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates 2D inverse discrete cosine transform.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mtrx</span>
<span class="sd">        Input matrix.  </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------    </span>
<span class="sd">    Inverse of discrete cosine transform of the input matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
     
    <span class="c1"># Check if input object is 2D.</span>
    <span class="k">if</span> <span class="n">mtrx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passed object should be a matrix or a numpy array with dimension of two.&quot;</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">idct</span><span class="p">(</span><span class="n">idct</span><span class="p">(</span><span class="n">mtrx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_shrinkageOperator</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">-</span> <span class="n">epsilon</span>
    <span class="n">temp1</span><span class="p">[</span><span class="n">temp1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="n">temp2</span><span class="p">[</span><span class="n">temp2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">+</span> <span class="n">temp2</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">_inexact_alm_rspca_l1</span><span class="p">(</span>
    <span class="n">images</span><span class="p">,</span> 
    <span class="n">lambda_flatfield</span><span class="p">,</span> 
    <span class="n">if_darkfield</span><span class="p">,</span> 
    <span class="n">lambda_darkfield</span><span class="p">,</span> 
    <span class="n">optimization_tolerance</span><span class="p">,</span> 
    <span class="n">max_iterations</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="p">):</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">weight</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;weight matrix has different size than input sequence&#39;</span><span class="p">)</span>

    <span class="c1"># Shape variables</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1"># Image height</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>           <span class="c1"># Image width</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>                       <span class="c1"># Total pixels per image</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>          <span class="c1"># Number of images</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

    <span class="c1"># SVD and Norm variables    </span>
    <span class="n">_</span><span class="p">,</span> <span class="n">svd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># SVD decomposition</span>
    <span class="n">norm_two</span> <span class="o">=</span> <span class="n">svd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Largest singular value</span>
    <span class="n">d_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span> <span class="c1"># Frobenius norm of images</span>

    <span class="c1"># Optimization parameters</span>
    <span class="n">dual_var_lowrank</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Dual variable for low-rank component (Y1)</span>
    <span class="n">lagrange_mult1</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Lagrange multiplier for first constraint (ent1)</span>
    <span class="n">lagrange_mult2</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Lagrange multiplier for second constraint (ent2)</span>
    <span class="n">penalty_factor</span> <span class="o">=</span> <span class="mf">12.5</span> <span class="o">/</span> <span class="n">norm_two</span> <span class="c1"># (mu)</span>
    <span class="n">penalty_factor_bar</span> <span class="o">=</span> <span class="n">penalty_factor</span> <span class="o">*</span> <span class="mf">1e7</span> <span class="c1"># Upper bound for penalty (mu_bar)</span>
    <span class="n">scale_ratio</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># Scale factor for penalty updates</span>

    <span class="c1"># Component matrices</span>
    <span class="n">A1_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="c1"># Estimated flat-field</span>
    <span class="n">A1_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Flat-field coefficients</span>
    <span class="n">E1_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="c1"># Estimated error/noise</span>
    <span class="n">W_hat</span> <span class="o">=</span> <span class="n">_dct2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># DCT coefficients</span>

    <span class="c1"># Offset and mask variables</span>
    <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># Offset for flatfield</span>
    <span class="n">B1_uplimit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="c1"># Upper limit for darkfield</span>
    <span class="n">B1_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Darkfield offset</span>
    <span class="n">A_inmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span> <span class="c1"># Inner mask for optimization</span>
    <span class="c1"># Mask covers central region (5/6 x 5/6)</span>
    <span class="n">A_inmask</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># main iteration loop starts</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_svd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
 
        <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A1_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">A1_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A_offset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">A_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">W_idct_hat</span> <span class="o">=</span> <span class="n">_idct2d</span><span class="p">(</span><span class="n">W_hat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">A1_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">A1_coeff</span><span class="p">)</span> <span class="o">+</span> <span class="n">A_offset</span>

        <span class="n">temp_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span> <span class="o">-</span> <span class="n">A1_hat</span> <span class="o">-</span> <span class="n">E1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">penalty_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">dual_var_lowrank</span><span class="p">)</span> <span class="o">/</span> <span class="n">lagrange_mult1</span>
        <span class="n">temp_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">temp_W</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">temp_W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temp_W</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">W_hat</span> <span class="o">=</span> <span class="n">W_hat</span> <span class="o">+</span> <span class="n">_dct2d</span><span class="p">(</span><span class="n">temp_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">W_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">W_hat</span> <span class="o">-</span> <span class="n">lambda_flatfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult1</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">W_hat</span> <span class="o">+</span> <span class="n">lambda_flatfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult1</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">W_idct_hat</span> <span class="o">=</span> <span class="n">_idct2d</span><span class="p">(</span><span class="n">W_hat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A1_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">A1_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A_offset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">A_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">A1_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">A1_coeff</span><span class="p">)</span> <span class="o">+</span> <span class="n">A_offset</span>
        <span class="n">E1_hat</span> <span class="o">=</span> <span class="n">images</span> <span class="o">-</span> <span class="n">A1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">penalty_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">dual_var_lowrank</span> <span class="o">/</span> <span class="n">lagrange_mult1</span>
        <span class="n">E1_hat</span> <span class="o">=</span> <span class="n">_shrinkageOperator</span><span class="p">(</span><span class="n">E1_hat</span><span class="p">,</span> <span class="n">weight</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult1</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">))</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">images</span> <span class="o">-</span> <span class="n">E1_hat</span>
        <span class="n">A1_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
        <span class="n">A1_coeff</span><span class="p">[</span><span class="n">A1_coeff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">if_darkfield</span><span class="p">:</span>
            <span class="n">validA1coeff_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A1_coeff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">B1_coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">][:,</span> <span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">][:,</span> <span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">validA1coeff_idx</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">[</span><span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">temp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">[</span><span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">temp3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B1_coeff</span><span class="p">)</span>
            <span class="n">temp4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">[</span><span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">B1_coeff</span><span class="p">)</span>
            <span class="n">temp5</span> <span class="o">=</span> <span class="n">temp2</span> <span class="o">*</span> <span class="n">temp3</span> <span class="o">-</span> <span class="n">temp4</span> <span class="o">*</span> <span class="n">k</span>
            <span class="k">if</span> <span class="n">temp5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">B1_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">B1_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">*</span> <span class="n">temp3</span> <span class="o">-</span> <span class="n">temp2</span> <span class="o">*</span> <span class="n">temp4</span><span class="p">)</span> <span class="o">/</span> <span class="n">temp5</span>

            <span class="n">B1_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">B1_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">B1_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">B1_offset</span><span class="p">,</span> <span class="n">B1_uplimit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">))</span>
            <span class="n">B_offset</span> <span class="o">=</span> <span class="n">B1_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">B_offset</span> <span class="o">=</span> <span class="n">B_offset</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">B_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">B1_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">)</span>

            <span class="n">A1_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">[:,</span> <span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A1_coeff</span><span class="p">[</span><span class="n">validA1coeff_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">A1_offset</span> <span class="o">=</span> <span class="n">A1_offset</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A1_offset</span><span class="p">)</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">A1_offset</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A1_offset</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_offset</span>

            <span class="c1"># smooth A_offset</span>
            <span class="n">W_offset</span> <span class="o">=</span> <span class="n">_dct2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A_offset</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">W_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">W_offset</span> <span class="o">-</span> <span class="n">lambda_darkfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult2</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">W_offset</span> <span class="o">+</span> <span class="n">lambda_darkfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult2</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">_idct2d</span><span class="p">(</span><span class="n">W_offset</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A_offset</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

            <span class="c1"># encourage sparse A_offset</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">A_offset</span> <span class="o">-</span> <span class="n">lambda_darkfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult2</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">A_offset</span> <span class="o">+</span> <span class="n">lambda_darkfield</span> <span class="o">/</span> <span class="p">(</span><span class="n">lagrange_mult2</span> <span class="o">*</span> <span class="n">penalty_factor</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">A_offset</span> <span class="o">=</span> <span class="n">A_offset</span> <span class="o">+</span> <span class="n">B_offset</span>


        <span class="n">Z1</span> <span class="o">=</span> <span class="n">images</span> <span class="o">-</span> <span class="n">A1_hat</span> <span class="o">-</span> <span class="n">E1_hat</span> <span class="c1"># Constraint violation</span>
        <span class="n">dual_var_lowrank</span> <span class="o">=</span> <span class="n">dual_var_lowrank</span> <span class="o">+</span> <span class="n">penalty_factor</span> <span class="o">*</span> <span class="n">Z1</span> <span class="c1"># Dual variable updates</span>
        <span class="n">penalty_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">penalty_factor</span> <span class="o">*</span> <span class="n">scale_ratio</span><span class="p">,</span> <span class="n">penalty_factor_bar</span><span class="p">)</span>
        
        <span class="c1"># Stop Criterion</span>
        <span class="n">stopCriterion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s1">&#39;fro&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_norm</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Iteration </span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s1">, stopCriterion: </span><span class="si">{</span><span class="n">stopCriterion</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stopCriterion</span> <span class="o">&lt;</span> <span class="n">optimization_tolerance</span><span class="p">:</span>
            <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
            <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">A_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">A_offset</span><span class="p">)</span>
    <span class="n">A_offset</span> <span class="o">=</span> <span class="n">A_offset</span> <span class="o">+</span> <span class="n">B1_offset</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W_idct_hat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A1_hat</span><span class="p">,</span> <span class="n">E1_hat</span><span class="p">,</span> <span class="n">A_offset</span>

<span class="k">def</span> <span class="nf">_resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">side_size</span><span class="p">:</span> <span class="nb">float</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_side_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_side_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">side_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_side_size</span> <span class="o">=</span> <span class="n">x_side_size</span> <span class="o">=</span> <span class="n">side_size</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x_side_size</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y_side_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">skresize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x_side_size</span><span class="p">,</span> <span class="n">y_side_size</span><span class="p">),</span> 
            <span class="n">order</span> <span class="o">=</span> <span class="n">RESIZE_ORDER</span><span class="p">,</span> 
            <span class="n">mode</span> <span class="o">=</span> <span class="n">RESIZE_MODE</span><span class="p">,</span>
            <span class="n">preserve_range</span> <span class="o">=</span> <span class="n">PRESERVE_RANGE</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimate-correction">
<h3>3.4 Estimate Correction<a class="headerlink" href="#estimate-correction" title="Link to this heading">#</a></h3>
<p>The following cell runs the illumination correction estimation and returns two models.  It is based on the Basic correction algorithm implemented by the Peng lab <a class="github reference external" href="https://github.com/peng-lab">peng-lab</a> as a Cellprofiler plugin.  Here is where you may make changes to tune the algorithm for optimal results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tunable parameters</span>
<span class="n">if_darkfield</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">optimization_tolerance</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">max_reweight_iterations</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">reweight_tolerance</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XAoffset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">downsized_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">flag_reweighting</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">flatfield_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span>
<span class="n">darkfield_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
<span class="n">sorted_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">downsized_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">lambda_flatfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Dis_Cos_Trans_mean</span><span class="p">))</span> <span class="o">/</span> <span class="mi">400</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">lambda_darkfield</span> <span class="o">=</span> <span class="n">lambda_flatfield</span> <span class="o">*</span> <span class="mf">0.2</span>
<span class="n">reweighting_iter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">flag_reweighting</span><span class="p">:</span>
    <span class="n">reweighting_iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">initial_flatfield</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">initial_flatfield</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Initial flatfield option not implemented yet!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_k_A</span><span class="p">,</span> <span class="n">X_k_E</span><span class="p">,</span> <span class="n">X_k_Aoffset</span> <span class="o">=</span> <span class="n">_inexact_alm_rspca_l1</span><span class="p">(</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">sorted_images</span><span class="p">,</span> 
            <span class="n">lambda_flatfield</span> <span class="o">=</span> <span class="n">lambda_flatfield</span><span class="p">,</span>
            <span class="n">if_darkfield</span> <span class="o">=</span> <span class="n">if_darkfield</span><span class="p">,</span> 
            <span class="n">lambda_darkfield</span> <span class="o">=</span> <span class="n">lambda_darkfield</span><span class="p">,</span> 
            <span class="n">optimization_tolerance</span> <span class="o">=</span> <span class="n">optimization_tolerance</span><span class="p">,</span> 
            <span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="n">weight</span>
        <span class="p">)</span>

    <span class="n">XA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_k_A</span><span class="p">,</span> <span class="p">[</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">XE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_k_E</span><span class="p">,</span> <span class="p">[</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">XAoffset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_k_Aoffset</span><span class="p">,</span> <span class="p">[</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">XE_norm</span> <span class="o">=</span> <span class="n">XE</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">XE_norm</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">XE_norm</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">weight</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">XAoffset</span>
    <span class="n">flatfield_current</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="n">darkfield_current</span> <span class="o">=</span> <span class="n">XAoffset</span>
    <span class="n">mad_flatfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flatfield_current</span> <span class="o">-</span> <span class="n">flatfield_last</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flatfield_last</span><span class="p">))</span>
    <span class="n">temp_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">darkfield_current</span> <span class="o">-</span> <span class="n">darkfield_last</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">temp_diff</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">:</span>
        <span class="n">mad_darkfield</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mad_darkfield</span> <span class="o">=</span> <span class="n">temp_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">darkfield_last</span><span class="p">)),</span> <span class="mf">1e-6</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Re-weighting iteration </span><span class="si">{</span><span class="n">reweighting_iter</span><span class="si">}</span><span class="s2">: MAD flatfield = </span><span class="si">{</span><span class="n">mad_flatfield</span><span class="si">}</span><span class="s2">; MAD darkfield = </span><span class="si">{</span><span class="n">mad_darkfield</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">flatfield_last</span> <span class="o">=</span> <span class="n">flatfield_current</span>
    <span class="n">darkfield_last</span> <span class="o">=</span> <span class="n">darkfield_current</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mad_flatfield</span><span class="p">,</span>
                    <span class="n">mad_darkfield</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">reweight_tolerance</span> <span class="ow">or</span> \
            <span class="n">reweighting_iter</span> <span class="o">&gt;=</span> <span class="n">max_reweight_iterations</span><span class="p">:</span>
        <span class="n">flag_reweighting</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">shading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">XA</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">XAoffset</span>
<span class="n">flatfield</span> <span class="o">=</span> <span class="n">_resize_image</span><span class="p">(</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">shading</span><span class="p">,</span> 
    <span class="n">x_side_size</span> <span class="o">=</span> <span class="n">_saved_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
    <span class="n">y_side_size</span> <span class="o">=</span> <span class="n">_saved_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">flatfield</span> <span class="o">=</span> <span class="n">flatfield</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># Ensure floating point</span>
<span class="n">flatfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">flatfield</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Prevent division by zero</span>
<span class="n">flatfield</span> <span class="o">=</span> <span class="n">flatfield</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flatfield</span><span class="p">[</span><span class="n">flatfield</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

<span class="k">if</span> <span class="n">if_darkfield</span><span class="p">:</span>
    <span class="n">darkfield</span> <span class="o">=</span> <span class="n">_resize_image</span><span class="p">(</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">XAoffset</span><span class="p">,</span> 
        <span class="n">x_side_size</span> <span class="o">=</span> <span class="n">_saved_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
        <span class="n">y_side_size</span> <span class="o">=</span> <span class="n">_saved_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">darkfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">flatfield</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14155038602825354
Iteration 3, stopCriterion: 0.14155038602825357
Iteration 4, stopCriterion: 0.14155038602825354
Iteration 5, stopCriterion: 0.14155038602825357
Iteration 6, stopCriterion: 0.13000398055929482
Iteration 7, stopCriterion: 0.125656373521215
Iteration 8, stopCriterion: 0.11993881840682678
Iteration 9, stopCriterion: 0.11623117550444757
Iteration 10, stopCriterion: 0.11011458150226588
Iteration 11, stopCriterion: 0.09860844410552007
Iteration 12, stopCriterion: 0.08336823527051722
Iteration 13, stopCriterion: 0.06595570861493556
Iteration 14, stopCriterion: 0.049463810862908346
Iteration 15, stopCriterion: 0.03565225054128473
Iteration 16, stopCriterion: 0.025161886761161826
Iteration 17, stopCriterion: 0.01727595997149152
Iteration 18, stopCriterion: 0.011287160464979762
Iteration 19, stopCriterion: 0.007023142162465135
Iteration 20, stopCriterion: 0.004189406884084067
Iteration 21, stopCriterion: 0.002436570232157506
Iteration 22, stopCriterion: 0.0013891429707276032
Iteration 23, stopCriterion: 0.0007815563100315947
Iteration 24, stopCriterion: 0.00043761052934568546
Iteration 25, stopCriterion: 0.0002454534877361926
Iteration 26, stopCriterion: 0.00013751558486305214
Iteration 27, stopCriterion: 7.71065350198942e-05
Iteration 28, stopCriterion: 4.366673483117513e-05
Iteration 29, stopCriterion: 2.4692268055010185e-05
Iteration 30, stopCriterion: 1.3999383900333331e-05
Iteration 31, stopCriterion: 8.046130313819852e-06
Iteration 32, stopCriterion: 4.649879165094201e-06
Iteration 33, stopCriterion: 2.7078549936766972e-06
Iteration 34, stopCriterion: 1.532751173244526e-06
Iteration 35, stopCriterion: 8.96597777405873e-07
Re-weighting iteration 1: MAD flatfield = 0.06841825763722742; MAD darkfield = 13.15701118195205
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152212755547358
Iteration 3, stopCriterion: 0.1414322633357202
Iteration 4, stopCriterion: 0.14108489814232142
Iteration 5, stopCriterion: 0.14031308838655313
Iteration 6, stopCriterion: 0.1269684882121084
Iteration 7, stopCriterion: 0.11984251979295174
Iteration 8, stopCriterion: 0.10976543119872813
Iteration 9, stopCriterion: 0.10063358054221337
Iteration 10, stopCriterion: 0.08999667780671941
Iteration 11, stopCriterion: 0.07757356451685471
Iteration 12, stopCriterion: 0.06401965788986377
Iteration 13, stopCriterion: 0.050785520775716776
Iteration 14, stopCriterion: 0.03910966227503952
Iteration 15, stopCriterion: 0.029556437758211197
Iteration 16, stopCriterion: 0.02196378978083629
Iteration 17, stopCriterion: 0.01592069511195456
Iteration 18, stopCriterion: 0.0111754339028038
Iteration 19, stopCriterion: 0.007578831435085328
Iteration 20, stopCriterion: 0.004951979445655774
Iteration 21, stopCriterion: 0.0031159793772125677
Iteration 22, stopCriterion: 0.0019030922674941754
Iteration 23, stopCriterion: 0.0011282282312066185
Iteration 24, stopCriterion: 0.0006532079222310018
Iteration 25, stopCriterion: 0.0003702548049085131
Iteration 26, stopCriterion: 0.00020762108719193633
Iteration 27, stopCriterion: 0.00011569652663829546
Iteration 28, stopCriterion: 6.428892830125026e-05
Iteration 29, stopCriterion: 3.586016057941875e-05
Iteration 30, stopCriterion: 2.0118532356864926e-05
Iteration 31, stopCriterion: 1.1227229468495542e-05
Iteration 32, stopCriterion: 6.363173452446693e-06
Iteration 33, stopCriterion: 3.643115441263514e-06
Iteration 34, stopCriterion: 2.0732338528577093e-06
Iteration 35, stopCriterion: 1.162281379176421e-06
Iteration 36, stopCriterion: 6.644596537184485e-07
Re-weighting iteration 2: MAD flatfield = 0.01577519598761884; MAD darkfield = 0.3692462003088035
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152171737678587
Iteration 3, stopCriterion: 0.14142580868308063
Iteration 4, stopCriterion: 0.14106559376213545
Iteration 5, stopCriterion: 0.140251491334395
Iteration 6, stopCriterion: 0.12682092173651865
Iteration 7, stopCriterion: 0.11958386540620981
Iteration 8, stopCriterion: 0.10939801053199731
Iteration 9, stopCriterion: 0.10011113633090214
Iteration 10, stopCriterion: 0.08934268476989086
Iteration 11, stopCriterion: 0.07692979633745148
Iteration 12, stopCriterion: 0.06341236475317638
Iteration 13, stopCriterion: 0.0503224201190199
Iteration 14, stopCriterion: 0.038736511882651786
Iteration 15, stopCriterion: 0.02926371081021239
Iteration 16, stopCriterion: 0.021747566392789987
Iteration 17, stopCriterion: 0.01578596083859078
Iteration 18, stopCriterion: 0.011116210889014502
Iteration 19, stopCriterion: 0.007570602785623136
Iteration 20, stopCriterion: 0.0049676355766616566
Iteration 21, stopCriterion: 0.0031438229428640877
Iteration 22, stopCriterion: 0.001926311434667302
Iteration 23, stopCriterion: 0.001147277407844372
Iteration 24, stopCriterion: 0.0006680032654974984
Iteration 25, stopCriterion: 0.0003819167393630581
Iteration 26, stopCriterion: 0.00021456550790990226
Iteration 27, stopCriterion: 0.00012014608988579345
Iteration 28, stopCriterion: 6.722201077923536e-05
Iteration 29, stopCriterion: 3.7795741241537544e-05
Iteration 30, stopCriterion: 2.123662078673104e-05
Iteration 31, stopCriterion: 1.2059690351008046e-05
Iteration 32, stopCriterion: 6.849585070372029e-06
Iteration 33, stopCriterion: 3.8478418597090396e-06
Iteration 34, stopCriterion: 2.171782484916496e-06
Iteration 35, stopCriterion: 1.212041447028267e-06
Iteration 36, stopCriterion: 6.807499900142752e-07
Re-weighting iteration 3: MAD flatfield = 0.0040845642844147155; MAD darkfield = 0.11854339600773962
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152143984725254
Iteration 3, stopCriterion: 0.14142193997274802
Iteration 4, stopCriterion: 0.1410526123823176
Iteration 5, stopCriterion: 0.14022137309797567
Iteration 6, stopCriterion: 0.12675673096740667
Iteration 7, stopCriterion: 0.11948571996835636
Iteration 8, stopCriterion: 0.10926932288722936
Iteration 9, stopCriterion: 0.09993830112939654
Iteration 10, stopCriterion: 0.0891442632950872
Iteration 11, stopCriterion: 0.07673620235346651
Iteration 12, stopCriterion: 0.06323908836446657
Iteration 13, stopCriterion: 0.05018975695170536
Iteration 14, stopCriterion: 0.03862664446342415
Iteration 15, stopCriterion: 0.02918235587792941
Iteration 16, stopCriterion: 0.021692824660768457
Iteration 17, stopCriterion: 0.01575889693688016
Iteration 18, stopCriterion: 0.011112035332670255
Iteration 19, stopCriterion: 0.007576094766930791
Iteration 20, stopCriterion: 0.004975470232680299
Iteration 21, stopCriterion: 0.0031532510140699376
Iteration 22, stopCriterion: 0.0019307066523719832
Iteration 23, stopCriterion: 0.00115128927454388
Iteration 24, stopCriterion: 0.0006709306759175388
Iteration 25, stopCriterion: 0.000384040861614034
Iteration 26, stopCriterion: 0.0002159635091380446
Iteration 27, stopCriterion: 0.00012097924146413469
Iteration 28, stopCriterion: 6.817253203867407e-05
Iteration 29, stopCriterion: 3.841550085977534e-05
Iteration 30, stopCriterion: 2.1541493822001597e-05
Iteration 31, stopCriterion: 1.2202537863517218e-05
Iteration 32, stopCriterion: 6.917634188358262e-06
Iteration 33, stopCriterion: 3.977732173565903e-06
Iteration 34, stopCriterion: 2.2202158500151132e-06
Iteration 35, stopCriterion: 1.2616132044088371e-06
Iteration 36, stopCriterion: 7.371834488479314e-07
Re-weighting iteration 4: MAD flatfield = 0.0013281318807413472; MAD darkfield = 0.03699517611954515
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152128221793533
Iteration 3, stopCriterion: 0.1414200000963284
Iteration 4, stopCriterion: 0.1410456060716728
Iteration 5, stopCriterion: 0.14020687735767398
Iteration 6, stopCriterion: 0.12672650577248382
Iteration 7, stopCriterion: 0.11944152989492175
Iteration 8, stopCriterion: 0.1092132020250383
Iteration 9, stopCriterion: 0.0998674472569537
Iteration 10, stopCriterion: 0.08906451966190747
Iteration 11, stopCriterion: 0.0766608559942031
Iteration 12, stopCriterion: 0.06317122033413439
Iteration 13, stopCriterion: 0.050137703762785125
Iteration 14, stopCriterion: 0.0385832975561792
Iteration 15, stopCriterion: 0.029151846199991387
Iteration 16, stopCriterion: 0.021672714320141596
Iteration 17, stopCriterion: 0.01575145346564696
Iteration 18, stopCriterion: 0.011113104561666087
Iteration 19, stopCriterion: 0.007580358284276685
Iteration 20, stopCriterion: 0.004980018375309913
Iteration 21, stopCriterion: 0.0031570374950138104
Iteration 22, stopCriterion: 0.0019332669353112274
Iteration 23, stopCriterion: 0.0011530061750761953
Iteration 24, stopCriterion: 0.0006715230397986883
Iteration 25, stopCriterion: 0.0003849063541447764
Iteration 26, stopCriterion: 0.00021667055263887457
Iteration 27, stopCriterion: 0.00012135694470183474
Iteration 28, stopCriterion: 6.865715622166382e-05
Iteration 29, stopCriterion: 3.848954111529781e-05
Iteration 30, stopCriterion: 2.1720074500402973e-05
Iteration 31, stopCriterion: 1.2385814389006912e-05
Iteration 32, stopCriterion: 6.9858674657223755e-06
Iteration 33, stopCriterion: 3.951853462377484e-06
Iteration 34, stopCriterion: 2.198463421002487e-06
Iteration 35, stopCriterion: 1.2651626638507025e-06
Iteration 36, stopCriterion: 7.381917593566815e-07
Re-weighting iteration 5: MAD flatfield = 0.0005086205721336029; MAD darkfield = 0.013717915000058659
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.1415212016336768
Iteration 3, stopCriterion: 0.14141905106384692
Iteration 4, stopCriterion: 0.1410421281343643
Iteration 5, stopCriterion: 0.14019976436591225
Iteration 6, stopCriterion: 0.12671208463530942
Iteration 7, stopCriterion: 0.11942096985377706
Iteration 8, stopCriterion: 0.10918755798625826
Iteration 9, stopCriterion: 0.09983648611461948
Iteration 10, stopCriterion: 0.08902973466786615
Iteration 11, stopCriterion: 0.07662840708979189
Iteration 12, stopCriterion: 0.06314193508583629
Iteration 13, stopCriterion: 0.0501153525907306
Iteration 14, stopCriterion: 0.038599019444634924
Iteration 15, stopCriterion: 0.029110006926757616
Iteration 16, stopCriterion: 0.021649368445667973
Iteration 17, stopCriterion: 0.015741850063201827
Iteration 18, stopCriterion: 0.01111134405468755
Iteration 19, stopCriterion: 0.007581842619810522
Iteration 20, stopCriterion: 0.004982124980008133
Iteration 21, stopCriterion: 0.003159080866573035
Iteration 22, stopCriterion: 0.001934784212445227
Iteration 23, stopCriterion: 0.001153738028854838
Iteration 24, stopCriterion: 0.0006719214884794224
Iteration 25, stopCriterion: 0.0003854159316045339
Iteration 26, stopCriterion: 0.00021692022626527554
Iteration 27, stopCriterion: 0.0001215385275921599
Iteration 28, stopCriterion: 6.881622118883577e-05
Iteration 29, stopCriterion: 3.859818094397443e-05
Iteration 30, stopCriterion: 2.1882285998355113e-05
Iteration 31, stopCriterion: 1.2441833765714032e-05
Iteration 32, stopCriterion: 6.929170168290459e-06
Iteration 33, stopCriterion: 3.859850842415544e-06
Iteration 34, stopCriterion: 2.1977604898267928e-06
Iteration 35, stopCriterion: 1.2556375767463805e-06
Iteration 36, stopCriterion: 7.17497294941342e-07
Re-weighting iteration 6: MAD flatfield = 9.926684833172562e-05; MAD darkfield = 0.008295562968000587
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152115210804195
Iteration 3, stopCriterion: 0.14141852361267745
Iteration 4, stopCriterion: 0.14104020050830174
Iteration 5, stopCriterion: 0.14019605391569556
Iteration 6, stopCriterion: 0.12670483895877885
Iteration 7, stopCriterion: 0.11941138501847029
Iteration 8, stopCriterion: 0.10917617751007486
Iteration 9, stopCriterion: 0.09982412769216911
Iteration 10, stopCriterion: 0.08901595009259498
Iteration 11, stopCriterion: 0.07661574708616321
Iteration 12, stopCriterion: 0.06312985320999946
Iteration 13, stopCriterion: 0.05010533508932013
Iteration 14, stopCriterion: 0.03859029883089096
Iteration 15, stopCriterion: 0.029104433015858334
Iteration 16, stopCriterion: 0.02164612463690233
Iteration 17, stopCriterion: 0.01574144530442187
Iteration 18, stopCriterion: 0.011112249174379203
Iteration 19, stopCriterion: 0.0075829588975213445
Iteration 20, stopCriterion: 0.004982974214955065
Iteration 21, stopCriterion: 0.0031597282975921403
Iteration 22, stopCriterion: 0.0019353153803235458
Iteration 23, stopCriterion: 0.0011539172618238924
Iteration 24, stopCriterion: 0.0006719467598241066
Iteration 25, stopCriterion: 0.00038567392352572286
Iteration 26, stopCriterion: 0.00021692981451836075
Iteration 27, stopCriterion: 0.00012173759450992946
Iteration 28, stopCriterion: 6.88357566350249e-05
Iteration 29, stopCriterion: 3.87121389768835e-05
Iteration 30, stopCriterion: 2.1882025032781635e-05
Iteration 31, stopCriterion: 1.2346160364909083e-05
Iteration 32, stopCriterion: 6.9693310520441e-06
Iteration 33, stopCriterion: 3.852890999347457e-06
Iteration 34, stopCriterion: 2.2417214798814925e-06
Iteration 35, stopCriterion: 1.2343086874174401e-06
Iteration 36, stopCriterion: 7.183219141782114e-07
Re-weighting iteration 7: MAD flatfield = 6.487888757293728e-05; MAD darkfield = 0.0026558312205925997
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.14152112969655337
Iteration 3, stopCriterion: 0.1414182779120668
Iteration 4, stopCriterion: 0.1410393062895571
Iteration 5, stopCriterion: 0.14019427356393538
Iteration 6, stopCriterion: 0.1267013083825689
Iteration 7, stopCriterion: 0.11940655190822173
Iteration 8, stopCriterion: 0.10917038196446262
Iteration 9, stopCriterion: 0.0998176031962106
Iteration 10, stopCriterion: 0.08900877657503092
Iteration 11, stopCriterion: 0.07660925084062527
Iteration 12, stopCriterion: 0.06312383452275595
Iteration 13, stopCriterion: 0.050100571025652914
Iteration 14, stopCriterion: 0.03858636871563721
Iteration 15, stopCriterion: 0.02910194149969104
Iteration 16, stopCriterion: 0.021644666605584874
Iteration 17, stopCriterion: 0.015741330871699225
Iteration 18, stopCriterion: 0.011112709049315541
Iteration 19, stopCriterion: 0.007583470038760755
Iteration 20, stopCriterion: 0.004983371871560479
Iteration 21, stopCriterion: 0.0031600623485936404
Iteration 22, stopCriterion: 0.0019355934286365375
Iteration 23, stopCriterion: 0.001153963643682963
Iteration 24, stopCriterion: 0.0006719841208180547
Iteration 25, stopCriterion: 0.0003857942127061863
Iteration 26, stopCriterion: 0.00021697379715287124
Iteration 27, stopCriterion: 0.00012183383641850023
Iteration 28, stopCriterion: 6.883366616913065e-05
Iteration 29, stopCriterion: 3.8718825690696165e-05
Iteration 30, stopCriterion: 2.186024442901237e-05
Iteration 31, stopCriterion: 1.2320132018839944e-05
Iteration 32, stopCriterion: 6.962996850925784e-06
Iteration 33, stopCriterion: 3.9105518256321385e-06
Iteration 34, stopCriterion: 2.2064337023584773e-06
Iteration 35, stopCriterion: 1.2221678723532926e-06
Iteration 36, stopCriterion: 7.160299466279619e-07
Re-weighting iteration 8: MAD flatfield = 3.884057544930174e-05; MAD darkfield = 0.0013389647792079208
Iteration 1, stopCriterion: 0.7669555185990499
Iteration 2, stopCriterion: 0.1415211190414165
Iteration 3, stopCriterion: 0.14141816054601994
Iteration 4, stopCriterion: 0.14103888130459144
Iteration 5, stopCriterion: 0.14019341211736155
Iteration 6, stopCriterion: 0.12669959023016417
Iteration 7, stopCriterion: 0.11940417463594559
Iteration 8, stopCriterion: 0.10916751190967729
Iteration 9, stopCriterion: 0.09981433269282108
Iteration 10, stopCriterion: 0.08900517851893605
Iteration 11, stopCriterion: 0.07660599808832155
Iteration 12, stopCriterion: 0.06312084112308741
Iteration 13, stopCriterion: 0.050098237136487374
Iteration 14, stopCriterion: 0.03858450038392526
Iteration 15, stopCriterion: 0.02910076543257011
Iteration 16, stopCriterion: 0.021643998643213765
Iteration 17, stopCriterion: 0.015741296367534303
Iteration 18, stopCriterion: 0.011112946667903167
Iteration 19, stopCriterion: 0.007583729305077555
Iteration 20, stopCriterion: 0.004983559129575262
Iteration 21, stopCriterion: 0.003160226015305052
Iteration 22, stopCriterion: 0.0019357405390399136
Iteration 23, stopCriterion: 0.001153980177952543
Iteration 24, stopCriterion: 0.000672017831483811
Iteration 25, stopCriterion: 0.00038585796164715327
Iteration 26, stopCriterion: 0.00021700427784839118
Iteration 27, stopCriterion: 0.00012183593399589807
Iteration 28, stopCriterion: 6.887826873215536e-05
Iteration 29, stopCriterion: 3.87424527104442e-05
Iteration 30, stopCriterion: 2.1806907159588582e-05
Iteration 31, stopCriterion: 1.2319739614020704e-05
Iteration 32, stopCriterion: 6.97676080995546e-06
Iteration 33, stopCriterion: 3.911360523053695e-06
Iteration 34, stopCriterion: 2.183152344947646e-06
Iteration 35, stopCriterion: 1.2388260700440851e-06
Iteration 36, stopCriterion: 7.026782200337482e-07
Re-weighting iteration 9: MAD flatfield = 2.0883840268858057e-05; MAD darkfield = 0.0007139940619226233
</pre></div>
</div>
</div>
</div>
<p>Visualize intermediate results as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre re-weighting flatfield image shape is </span><span class="si">{</span><span class="n">XA</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">XA</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">XA</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">XA</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error image shape is </span><span class="si">{</span><span class="n">XE</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">XE</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">XE</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">XE</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">XA</span><span class="p">)</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">XE</span><span class="p">)</span>
<span class="n">hist3</span><span class="p">,</span> <span class="n">hist_centers3</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">XAoffset</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">XA</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pre re-weighting flatfield&#39;</span><span class="p">)</span> 
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">XE</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Optimized error&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">XAoffset</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pre re-weighting darkfield&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers3</span><span class="p">,</span> <span class="n">hist3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pre re-weighting flatfield image shape is (128, 128, 63) and type is float64
Min value is 106.18118960829489 and max value is 1397.2966199971409
Error image shape is (128, 128, 63) and type is float64
Min value is -615.0854998235193 and max value is 1620.7092562288185
</pre></div>
</div>
<img alt="../../_images/42dc598f6f40a6b98ab8262b63476381febaf2dd0d29a6342e6adc4150abae2e.png" src="../../_images/42dc598f6f40a6b98ab8262b63476381febaf2dd0d29a6342e6adc4150abae2e.png" />
</div>
</div>
<p>Visualize the models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flatfield image shape is </span><span class="si">{</span><span class="n">flatfield</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">flatfield</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">flatfield</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">flatfield</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Darkfield image shape is </span><span class="si">{</span><span class="n">darkfield</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">darkfield</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">darkfield</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">darkfield</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">flatfield</span><span class="p">)</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">darkfield</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flatfield</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flatfield&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">darkfield</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Darkfield&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Flatfield image shape is (1440, 1920) and type is float64
Min value is 0.6805011158921253 and max value is 1.2045346634920895
Darkfield image shape is (1440, 1920) and type is float64
Min value is -42.794995038941806 and max value is 34.172399856656696
</pre></div>
</div>
<img alt="../../_images/fdd9ccf35ddf60e688712a8a9f1fe73a0713ca3c6d759ea9a443d3b0ecb6c61b.png" src="../../_images/fdd9ccf35ddf60e688712a8a9f1fe73a0713ca3c6d759ea9a443d3b0ecb6c61b.png" />
</div>
</div>
</section>
<section id="apply-to-data">
<h3>3.5 Apply to Data<a class="headerlink" href="#apply-to-data" title="Link to this heading">#</a></h3>
<p>If you are satisfied with the results, apply the correction to a copy of the raw data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">)):</span>
    <span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="o">-</span> <span class="n">darkfield</span><span class="p">)</span> <span class="o">/</span> <span class="n">flatfield</span><span class="p">)</span>
    <span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="p">(</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>Visualize the original and compare to the corrected image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">=</span><span class="mi">15</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original image shape is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">im_array_init</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corrected image shape is </span><span class="si">{</span><span class="n">corrected</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and type is </span><span class="si">{</span><span class="n">corrected</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">Min value is </span><span class="si">{</span><span class="n">corrected</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> and max value is </span><span class="si">{</span><span class="n">corrected</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">hist_centers</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">hist2</span><span class="p">,</span> <span class="n">hist_centers2</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Corrected image&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_centers2</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Pixel Intensities&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original image shape is (63, 1440, 1920) and type is uint16
Min value is 0 and max value is 4855
Corrected image shape is (63, 1440, 1920) and type is uint16
Min value is 0 and max value is 4855
</pre></div>
</div>
<img alt="../../_images/9ccd1584a8a4ebbf4e09711b7013f76eb20d5155598782f6e30cfac6ec64d04c.png" src="../../_images/9ccd1584a8a4ebbf4e09711b7013f76eb20d5155598782f6e30cfac6ec64d04c.png" />
</div>
</div>
</section>
</section>
<section id="stitching">
<h2>4. Stitching<a class="headerlink" href="#stitching" title="Link to this heading">#</a></h2>
<section id="find-stitching-positions-and-save-model">
<h3>4.1 Find Stitching Positions and Save Model<a class="headerlink" href="#find-stitching-positions-and-save-model" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Here we stitch the original and corrected tiles for comparison.  This is accomplished using the package m2stitch <a class="github reference external" href="https://github.com/yfukai/m2stitch">yfukai/m2stitch</a>.</p></li>
<li><p>Enter the number of rows and columns, and overlap percentage known from your data.</p></li>
<li><p>Adjust pou (percent overlap uncertainty) and/or overlap_percentage to affect stitching quality.</p></li>
<li><p>The rows and columns functions are for generating lists corresponding to a “snake by rows” pattern starting at the upper left of the image.  They will need to be changed for other stitching patterns.</p></li>
<li><p>Enter use_gpu=True to use your gpu; False to use CPU.</p></li>
<li><p>To save and reuse stitching results, uncomment/comment out the appropriate lines.  The results are saved to the metadata folder defined above.</p></li>
<li><p>Be sure to closely evaluate the areas of overlap for stitching quality.  The cells below allow for visualizing in this notebook and for saving to inspect elsewhere.</p></li>
<li><p>For more information see <a class="github reference external" href="https://github.com/yfukai/m2stitch">yfukai/m2stitch</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># Number of rows (height)</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># Number of columns (width)</span>
<span class="n">overlap_percentage</span> <span class="o">=</span> <span class="mf">0.30</span>

<span class="n">pou</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">stitch_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;result.pkl&quot;</span><span class="p">)</span>

<span class="c1"># Row coordinates: each row index is repeated m times</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>

<span class="c1"># Column coordinates: snake pattern for each row, going back and forth</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="p">))</span>
<span class="n">result_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stitch_images</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">initial_ncc_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">overlap_percentage</span><span class="o">=</span><span class="n">overlap_percentage</span><span class="p">,</span> <span class="n">pou</span><span class="o">=</span><span class="n">pou</span><span class="p">,</span> <span class="n">max_cores</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">result_df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">stitch_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="section-4-2">
<h3>Section 4.2<a class="headerlink" href="#section-4-2" title="Link to this heading">#</a></h3>
<p>If the cell above has already been run to create a stitching model, run the cell below to apply it to the original images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stitch_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;result.pkl&quot;</span><span class="p">)</span>

<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">stitch_model</span><span class="p">)</span>

<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">size_y</span> <span class="o">=</span> <span class="n">im_array_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">size_x</span> <span class="o">=</span> <span class="n">im_array_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">stitched_image_size</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stitched_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">im_array_init</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">stitched_image_size</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">stitched_image</span><span class="p">[</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">im_array_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Visualize the result of stitching the original tiles.  Uncomment and enter values for x1, x2 y1, y2, and comment out the first “im” line while uncommenting out the second “im” line to crop the image.</p></li>
<li><p>You may want to crop areas of overlap to inspect the stitching quality.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># x1 = 1810</span>
<span class="c1"># x2 = 2050</span>
<span class="c1"># y1 = 1330</span>
<span class="c1"># y2 = 1650</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stitched_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="c1"># im = axes.imshow(stitched_image[y1:y2,x1:x2], vmax=None)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2de748fd24e8c7748d66efd8e3d26626ad2eecead05d2bcbb2de4e8cc6b43666.png" src="../../_images/2de748fd24e8c7748d66efd8e3d26626ad2eecead05d2bcbb2de4e8cc6b43666.png" />
</div>
</div>
<p>Save the stitched image if desired.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_image_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;test_original.tif&quot;</span><span class="p">)</span> 
<span class="n">imsave</span><span class="p">(</span><span class="n">raw_image_file_path</span><span class="p">,</span> <span class="n">stitched_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="section-4-3">
<h3>Section 4.3<a class="headerlink" href="#section-4-3" title="Link to this heading">#</a></h3>
<p>Reuse the stitching model to stitch the corrected tiles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">stitch_model</span><span class="p">)</span>
<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">size_y</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">size_x</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">stitched_image_size</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
    <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stitched_image_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">stitched_image_size</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">stitched_image_corrected</span><span class="p">[</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;y_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_y</span><span class="p">,</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;x_pos2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">size_x</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Visualize the result of stitching the corrected tiles.  Comment/uncomment the coordinates to crop.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="c1"># x1 = 6000</span>
<span class="c1"># x2 = 8000</span>
<span class="c1"># y1 = 0000</span>
<span class="c1"># y2 = 3000</span>
<span class="c1"># im = axes.imshow(stitched_image_corrected[y1:y2,x1:x2])</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stitched_image_corrected</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/199233f779f601754fbc3a5352ba6d815ec27e1409d6de89a6091fd9224901fe.png" src="../../_images/199233f779f601754fbc3a5352ba6d815ec27e1409d6de89a6091fd9224901fe.png" />
</div>
</div>
<p>Save the corrected stitched image if desired.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_image_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">,</span> <span class="s2">&quot;test_corrected.tif&quot;</span><span class="p">)</span> 
<span class="n">imsave</span><span class="p">(</span><span class="n">result_image_file_path</span><span class="p">,</span> <span class="n">stitched_image_corrected</span><span class="p">,</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Before testing deconvolution, you must correct and stitch an entire z-stack.  For this you can run the cells above for each image in the stack, or use the notebook for batch processing: 2_Cycle_Processing.ipynb</p>
</section>
</section>
<section id="deconvolution">
<h2>5. Deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The original deconvolution program was written in Matlab for lightsheet images.  It has been extensively modified for use with widefield fluorescence.  See <a class="reference external" href="https://www.nature.com/articles/s41598-019-53875-y">https://www.nature.com/articles/s41598-019-53875-y</a></p></li>
<li><p>Enter the necessary parameters in the cell below.  The “iterations” and “stop_criterion” values can be tuned to get good results.  The stop criteria will be the % mean squared error between iterations. The damping and hist_clip further can improve results by removing noise and limiting extreme pixel values, respectively.</p></li>
<li><p>There is no need to supply a point-spread function.</p></li>
<li><p>Finding the optimal use of computing resources on GPU or CPU is accomplished via the max_memory and blocksize parameters.  Max memory will be defined based on 80% of physical memory for GPU.  You may specify a blocksize that fits with your device architecture and dataset (multiples of 32 work well) or set to “1” for an automatic determination.  Automatic determination requires a lower (0.30-0.50) max_memory. Using these methods, there is no practical limit to image size.</p></li>
<li><p>Be sure the MATLAB Runtime (R2024a) is installed.  Download for free here: <a class="reference external" href="http://www.mathworks.com/products/compiler/mcr/index.html">http://www.mathworks.com/products/compiler/mcr/index.html</a>. Reboot your computer after install.  Installation of the Matlab Runtime often conflicts with anti-virus/malware software and organizational IT policies.  For troubleshooting, install on an off-network computer where you are the administrator. If you get an error 22, download runtime 2018b and then try again.</p></li>
<li><p>The image_dir and stitch_dir definitions used previously will be again used here, and a new folder will be created to save the deconvolved images.</p></li>
<li><p>If there is an “Maximum variable size allowed on the device is exceeded.” error, then restart the kernel, decrease the max_memory parameter, and try again.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dec_cycles</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">dec_channels</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># pixel size in xy dimension (nanometers)</span>
<span class="n">xy_vox</span> <span class="o">=</span> <span class="mi">377</span>
<span class="c1"># pixel size in z dimension (nanometers)</span>
<span class="n">z_vox</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="c1"># Number of iterations of Lucy-Richardson algo before stopping unless stop_crit is met first</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">25</span>
<span class="c1"># Microscope objective numerical aperture</span>
<span class="n">mic_NA</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="c1"># Refractive index of tissue being imaged</span>
<span class="n">tissue_RI</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="c1"># Opening size in millimeters of objective aperture</span>
<span class="n">slit_aper</span> <span class="o">=</span> <span class="mf">6.5</span>
<span class="c1"># Focal length in millimeters of objective</span>
<span class="n">f_cyl</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Used to reduce noise.  Increase value for noisy images. (0-10)</span>
<span class="n">damping</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># If set, the deconvolved images will be clipped by this percent for max and min values, and then scaled to full range of bit depth. (0-5)</span>
<span class="n">hist_clip</span> <span class="o">=</span> <span class="mf">0.010</span>
<span class="c1"># Percent change between iterations to use as criteria to stop deconvolution.</span>
<span class="n">stop_criterion</span> <span class="o">=</span> <span class="mf">5.00</span>
<span class="c1"># Percent maximum GPU or CPU memory </span>
<span class="n">max_memory</span> <span class="o">=</span> <span class="mf">.5</span>
<span class="c1"># Enter &#39;GPU&#39; or &#39;CPU&#39;</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;GPU&#39;</span>
<span class="c1"># Chunk size in bytes</span>
<span class="n">blocksize</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="c1"># The excitation and emission wavelength in nanometers</span>
<span class="n">ex</span> <span class="o">=</span> <span class="mi">358</span>
<span class="n">em</span> <span class="o">=</span> <span class="mi">461</span>

<span class="n">decon_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_Decon&#39;</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_channels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decon_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dec_channels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">xy_vox</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_vox</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterations</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">mic_NA</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tissue_RI</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">em</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">f_cyl</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">slit_aper</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">damping</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">hist_clip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">stop_criterion</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_memory</span><span class="p">),</span> <span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>This cell defines the function to enable output of the Matlab script as it is processing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    
    <span class="n">rc</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>

    <span class="n">decon_exe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;KDecon_v4.exe&quot;</span><span class="p">)</span> 
    <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">decon_exe</span><span class="p">)</span> 

<span class="k">elif</span> <span class="n">os_system</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">:</span>

    <span class="n">mat_dir</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/MATLAB/MATLAB_Runtime/R2024a/&quot;</span> 
    <span class="n">decon_exe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;for_distribution_files_only&quot;</span><span class="p">,</span> <span class="s2">&quot;run_K_Decon_v4.sh&quot;</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">decon_exe</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mat_dir</span><span class="p">)</span>

<span class="n">run_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> 
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;deconvolved&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;deconvolved&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;C:\\Users\\smith6jt\\KINTSUGI\\KDecon_v4.exe&#39;,
 &#39;C:\\Users\\smith6jt\\KINTSUGI\\data\\1904_CC2B_BaSiC_Stitched\\cyc01\\CH1&#39;,
 &#39;377&#39;,
 &#39;1500&#39;,
 &#39;25&#39;,
 &#39;0.75&#39;,
 &#39;1.5&#39;,
 &#39;358&#39;,
 &#39;461&#39;,
 &#39;1&#39;,
 &#39;6.5&#39;,
 &#39;0&#39;,
 &#39;0.01&#39;,
 &#39;5.0&#39;,
 &#39;0.5&#39;,
 &#39;GPU&#39;,
 &#39;8192&#39;]
</pre></div>
</div>
</div>
</div>
<p>The following cell will compare the original to the deconvolved image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enter the cycle, channel, and z-plane for the image you want to evaluate.</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ch</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># Crop the image by entering the x and y coordinates below.</span>
<span class="n">x1</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">y1</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">y2</span> <span class="o">=</span> <span class="mi">1200</span>

<span class="n">source_image</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">))</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_Decon&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">source_image</span><span class="p">[</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
<span class="n">decon_image</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;deconvolved&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;deconv_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Deconvolved&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/53f0fdcb33d6803c197d99713cb3d28bbfc638c94f97ff2e4dd9b3873cec2e50.png" src="../../_images/53f0fdcb33d6803c197d99713cb3d28bbfc638c94f97ff2e4dd9b3873cec2e50.png" />
</div>
</div>
</section>
<section id="fiji-clij2-plugin-edf">
<h2>6. FIJI Clij2 plugin - EDF<a class="headerlink" href="#fiji-clij2-plugin-edf" title="Link to this heading">#</a></h2>
<section id="define-fiji-variables">
<h3>6.1 Define FIJI variables<a class="headerlink" href="#define-fiji-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The following section connects this notebook with a local installation of FIJI and a Clij2 plugin to run an Extended Depth of Focus variance projection macro along the deconvolved image stack.</p></li>
<li><p>The image calculation is best done on the GPU for efficient (~10x faster) processing although any OpenCL device may be used.</p></li>
<li><p>In the next cell, define path values and enter the amount of RAM to “ij_mem” (no more than 80% of system RAM is a good rule of thumb) to allow for the computation.</p></li>
<li><p>The following cells will list possible devices to use; the name of the device chosen must match exactly for “device.”</p></li>
<li><p>Note that if a CPU is used, an additional OpenCL driver may need to be installed (for example Intel Processors: <a class="reference external" href="https://www.intel.com/content/www/us/en/developer/articles/tool/opencl-drivers.html">https://www.intel.com/content/www/us/en/developer/articles/tool/opencl-drivers.html</a>).</p></li>
<li><p>A new folder will be created for the results, and the image can be inspected in another program and in the last cell.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiji_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;Fiji.app&quot;</span><span class="p">)</span>
<span class="n">javahome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;KINTSUGI&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21_windows-x64_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;jdk-21.0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">javahome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
<span class="n">mavenhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;KINTSUGI&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9-bin&#39;</span><span class="p">,</span><span class="s1">&#39;apache-maven-3.9.9&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mavenhome</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>

<span class="n">ij_mem</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">scyjava</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-Xmx</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ij_mem</span><span class="p">)</span><span class="si">}</span><span class="s1">g&#39;</span><span class="p">)</span>
<span class="n">ij</span> <span class="o">=</span> <span class="n">imagej</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">fiji_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-device-names">
<h3>6.2 Get Device Names<a class="headerlink" href="#get-device-names" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">platforms</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">get_platforms</span><span class="p">()</span>
<span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Device: </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Type: </span><span class="si">{</span><span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Select a CPU device (assuming the first CPU device found)</span>
<span class="n">cpu_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">platforms</span><span class="p">:</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">cl</span><span class="o">.</span><span class="n">device_type</span><span class="o">.</span><span class="n">CPU</span><span class="p">:</span>
            <span class="n">cpu_device</span> <span class="o">=</span> <span class="n">device</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">cpu_device</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Platform: Intel(R) OpenCL Graphics
  Device: Intel(R) UHD Graphics 770 - Type: ALL | GPU
Platform: NVIDIA CUDA
  Device: NVIDIA RTX A4500 - Type: ALL | GPU
Platform: Intel(R) OpenCL
  Device: 13th Gen Intel(R) Core(TM) i9-13900 - Type: ALL | CPU
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-channel-names">
<h3>6.3 Define Channel Names<a class="headerlink" href="#define-channel-names" title="Link to this heading">#</a></h3>
<p>Enter channel names below.  The EDF output images will be named accordingly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">channel_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cyc01.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc02.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD31&quot;</span><span class="p">,</span> <span class="s2">&quot;CD8&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty2c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc03.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD20&quot;</span><span class="p">,</span> <span class="s2">&quot;Ki67&quot;</span><span class="p">,</span> <span class="s2">&quot;CD3e&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc04.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;SMActin&quot;</span><span class="p">,</span> <span class="s2">&quot;Podoplanin&quot;</span><span class="p">,</span> <span class="s2">&quot;CD68&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc05.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;PanCK&quot;</span><span class="p">,</span> <span class="s2">&quot;CD21&quot;</span><span class="p">,</span> <span class="s2">&quot;CD4&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc06.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Lyve1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45RO&quot;</span><span class="p">,</span> <span class="s2">&quot;CD11c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc07.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD35&quot;</span><span class="p">,</span> <span class="s2">&quot;ECAD&quot;</span><span class="p">,</span> <span class="s2">&quot;CD107a&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc08.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD34&quot;</span><span class="p">,</span> <span class="s2">&quot;CD44&quot;</span><span class="p">,</span> <span class="s2">&quot;HLADR&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc09.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty9a&quot;</span><span class="p">,</span> <span class="s2">&quot;FoxP3&quot;</span><span class="p">,</span> <span class="s2">&quot;CD163&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc10.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty10a&quot;</span><span class="p">,</span> <span class="s2">&quot;CollagenIV&quot;</span><span class="p">,</span> <span class="s2">&quot;Vimentin&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc11.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty11a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD15&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc12.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Empty12a&quot;</span><span class="p">,</span> <span class="s2">&quot;CD5&quot;</span><span class="p">,</span> <span class="s2">&quot;CD1c&quot;</span><span class="p">],</span>
 <span class="s2">&quot;cyc13.tif&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13a&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13b&quot;</span><span class="p">,</span> <span class="s2">&quot;Blank13c&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-edf">
<h3>6.4 Run EDF<a class="headerlink" href="#run-edf" title="Link to this heading">#</a></h3>
<p>Enter the cycle and channel for the image you want to evaluate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">edf_cycles</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">edf_channels</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">decon_dir</span> <span class="o">=</span> <span class="n">stitch_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BaSiC_Stitched&#39;</span><span class="p">,</span> <span class="s1">&#39;_Decon&#39;</span><span class="p">)</span>
<span class="n">edf_dir</span> <span class="o">=</span> <span class="n">decon_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_Decon&#39;</span><span class="p">,</span> <span class="s1">&#39;_EDF&#39;</span><span class="p">)</span>
<span class="n">edf_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decon_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">edf_cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CH</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">edf_channels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;deconvolved&quot;</span><span class="p">)</span>
<span class="n">edf_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">edf_cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="n">channel_name_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cyc</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">edf_cycles</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)[</span><span class="n">edf_channels</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">edf_dest</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Enter the OpenCl device name determined above.  If the device is not a GPU, enter “False” for GPU.</p></li>
<li><p>Enter the radii and sigma value for blurring.</p></li>
<li><p>Enter the number of tiles for splitting in the x and y dimensions (CPU will generally need many more e.g. if GPU split is 3 in each dimension, CPU splits will be 20).</p></li>
<li><p>If there are z-planes at the start or end of the stack that need to be removed or do not contribute to any in-focus pixels, they may be removed by setting z_start and z_end.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;NVIDIA RTX A4500&quot;</span>

<span class="n">radius_x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">radius_y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">20.0</span>

<span class="n">xSplit</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ySplit</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">z_start</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">z_end</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">GPU</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">macro</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#@ File in_folder</span>
<span class="s2">#@ String device</span>
<span class="s2">#@ File out_folder</span>
<span class="s2">#@ String file_name</span>
<span class="s2">#@ Integer radius_x</span>
<span class="s2">#@ Integer radius_y</span>
<span class="s2">#@ Float sigma</span>
<span class="s2">#@ Integer xTiles</span>
<span class="s2">#@ Integer yTiles</span>
<span class="s2">#@ String z_start</span>
<span class="s2">#@ String z_end</span>
<span class="s2">#@ Boolean GPU</span>

<span class="s2">run(&quot;CLIJ2 Macro Extensions&quot;, &quot;cl_device=[&quot; + device + &quot;] automatic_output_naming=false&quot;);</span>
<span class="s2">Ext.CLIJ2_clear();</span>
<span class="s2">//setBatchMode(true);</span>

<span class="s2">File.openSequence(in_folder);</span>
<span class="s2">Stack.getDimensions(width, height, channels, slices, frames);</span>

<span class="s2">if (slices != z_end - z_start + 1) {</span>
<span class="s2">    run(&quot;Slice Keeper&quot;, &quot;first=&quot; + z_start + &quot; last=&quot; + z_end + &quot; increment=1&quot;);</span>
<span class="s2">    input = &quot;deconvolved kept stack&quot;;</span>
<span class="s2">    Stack.getDimensions(width, height, channels, slices, frames);</span>
<span class="s2">    } else {</span>
<span class="s2">    input = &quot;deconvolved&quot;;</span>
<span class="s2">}</span>

<span class="s2">if (GPU == true) {</span>
<span class="s2">	output = &quot;output&quot;;</span>
<span class="s2">	newImage(output, &quot;16-bit black&quot;, width, height, 1);</span>
<span class="s2">    } else {</span>
<span class="s2">    Ext.CLIJ2_push(input);</span>
<span class="s2">	Ext.CLIJ2_create2D(output, width, height, 16);</span>
<span class="s2">}</span>

<span class="s2">numTilesZ = 1;</span>
<span class="s2">numTilesX = xTiles;</span>
<span class="s2">numTilesY = yTiles;</span>

<span class="s2">tileDepth = round((slices/numTilesZ));</span>
<span class="s2">tileWidth = round((width/numTilesX));</span>
<span class="s2">tileHeight = round((height/numTilesY));</span>

<span class="s2">for (x = 0; x &lt; numTilesX; x++) {</span>
<span class="s2">	for (y = 0; y &lt; numTilesY; y++) {</span>
<span class="s2">		for (z = 0; z &lt; numTilesZ; z++) {</span>

<span class="s2">			Ext.CLIJ2_pushTile(input, x, y, z, tileWidth, tileHeight, tileDepth, 0, 0, 0);		</span>
<span class="s2">			Ext.CLIJ2_extendedDepthOfFocusVarianceProjection(input, output, radius_x, radius_y, sigma);</span>
<span class="s2">            Ext.CLIJ2_release(input);</span>
<span class="s2">            if (GPU == true) {</span>
<span class="s2">				Ext.CLIJ2_pullTile(output, x, y, z, tileWidth, tileHeight, 1, 0, 0, 0);</span>
<span class="s2">				Ext.CLIJ2_release(output);</span>
<span class="s2">			}            </span>
<span class="s2">		}</span>
<span class="s2">	}</span>
<span class="s2">}</span>

<span class="s2">if (GPU == false) {</span>
<span class="s2">	Ext.CLIJ2_pull(output);</span>
<span class="s2">    Ext.CLIJ2_release(output);</span>
<span class="s2">}</span>

<span class="s2">selectImage(output);</span>
<span class="s2">saveAs(&quot;Tiff&quot;, out_folder + File.separator + file_name);</span>

<span class="s2">Ext.CLIJ2_clear();</span>
<span class="s2">run(&quot;Close All&quot;);</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;in_folder&#39;</span><span class="p">:</span> <span class="n">edf_source</span><span class="p">,</span> 
		<span class="s2">&quot;device&quot;</span> <span class="p">:</span> <span class="n">device</span><span class="p">,</span> 
		<span class="s2">&quot;out_folder&quot;</span> <span class="p">:</span> <span class="n">edf_dest</span><span class="p">,</span> 
		<span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> 
		<span class="s2">&quot;radius_x&quot;</span> <span class="p">:</span> <span class="n">radius_x</span><span class="p">,</span> 
		<span class="s2">&quot;radius_y&quot;</span> <span class="p">:</span> <span class="n">radius_y</span><span class="p">,</span> 
		<span class="s2">&quot;sigma&quot;</span> <span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> 
		<span class="s2">&quot;xTiles&quot;</span> <span class="p">:</span> <span class="n">xSplit</span><span class="p">,</span> 
		<span class="s2">&quot;yTiles&quot;</span> <span class="p">:</span> <span class="n">ySplit</span><span class="p">,</span> 
		<span class="s2">&quot;z_start&quot;</span> <span class="p">:</span> <span class="n">z_start</span><span class="p">,</span> 
		<span class="s2">&quot;z_end&quot;</span> <span class="p">:</span> <span class="n">z_end</span><span class="p">,</span> 
		<span class="s2">&quot;GPU&quot;</span> <span class="p">:</span> <span class="n">GPU</span><span class="p">}</span>

<span class="n">ij</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">run_macro</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Operating in headless mode - the original ImageJ will have limited functionality.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;java object &#39;org.scijava.script.ScriptModule&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p>Visualize the results with periodic z-planes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decon_stack</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_source</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;deconv_0??.tif&quot;</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">alphanumeric_key</span><span class="p">)</span>
<span class="n">decon_stack</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">decon_stack</span><span class="p">)</span>
<span class="n">decon_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">decon_stack</span><span class="p">)</span>
<span class="n">edf_result</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_dest</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">))</span>

<span class="n">x1</span> <span class="o">=</span> <span class="mi">2400</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">y1</span> <span class="o">=</span> <span class="mi">2400</span>
<span class="n">y2</span> <span class="o">=</span> <span class="mi">3000</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;decon_z007&quot;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;decon_z008&quot;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;decon_z009&quot;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;decon_z010&quot;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decon_image</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;decon_z011&quot;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edf_result</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;EDF_var_radius_x5_radius_y5_sigma20&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b8fed7c385556ccd3e4c21841c2d38080bfe40027a11306fc5026826ad206676.png" src="../../_images/b8fed7c385556ccd3e4c21841c2d38080bfe40027a11306fc5026826ad206676.png" />
</div>
</div>
<p>Visualize the results as a full image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">edf_result</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edf_dest</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edf_result</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/753d53233325923caf9c37315b7b610a4515754b3c5306b3f76d052812295fc7.png" src="../../_images/753d53233325923caf9c37315b7b610a4515754b3c5306b3f76d052812295fc7.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./src\notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../Installation%20Steps.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Installation Steps</p>
      </div>
    </a>
    <a class="right-next"
       href="2_Cycle_Processing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Part 2: Batch Process</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-the-following-notebook-you-will-prepare-for-processing-your-images-test-illumination-correction-parameters-stitching-accuracy-and-deconvolution">In the following notebook you will prepare for processing your images; test illumination correction parameters, stitching accuracy, and deconvolution.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">*This must be done every time the notebook is started or restarted.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-method-a">2.1a Method A</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-method-b">2.1b Method B</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shorten-cycle-folder-names">2.2 Shorten cycle folder names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-test-set">2.4 Import test set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#illumination-correction">3. Illumination Correction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downsize-and-resize">3.1 Downsize and resize.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#take-mean-and-transform">3.2 Take Mean and Transform</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">3.3 Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-correction">3.4 Estimate Correction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-to-data">3.5 Apply to Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stitching">4. Stitching</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-stitching-positions-and-save-model">4.1 Find Stitching Positions and Save Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-4-2">Section 4.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-4-3">Section 4.3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">5. Deconvolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiji-clij2-plugin-edf">6. FIJI Clij2 plugin - EDF</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-fiji-variables">6.1 Define FIJI variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-device-names">6.2 Get Device Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-channel-names">6.3 Define Channel Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-edf">6.4 Run EDF</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Justin Smith
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>