
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Part 6: Cluster cells. &#8212; KINTSUGI</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'src/notebooks/6_Cluster_Cells';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Part 5: Cluster pixels." href="5_Cluster_Pixels.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../Intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cluster.gif" class="logo__image only-light" alt="KINTSUGI - Home"/>
    <img src="../../_static/cluster.gif" class="logo__image only-dark pst-js-only" alt="KINTSUGI - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../Intro.html">
                    KINTSUGI: Knowledge Integration with New Technologies for Simplified User-Guided Image processing
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Installation%20Steps.html">Installation Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Single_Channel_Eval.html">Part 1: Explore data, test and tune processing parameters.</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Cycle_Processing.html">Part 2: Batch Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Signal_Isolation.html">Part 3: Isolate signal from autofluorescence and noise.</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Segmentation.html">Part 4: Segment cells and nuclei.</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_Cluster_Pixels.html">Part 5: Cluster pixels.</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Part 6: Cluster cells.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/smith6jt-cop/KINTSUGI/issues/new?title=Issue%20on%20page%20%2Fsrc/notebooks/6_Cluster_Cells.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/src/notebooks/6_Cluster_Cells.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Part 6: Cluster cells.</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-parameters-for-cell-clustering-saved-during-2-cluster-pixels-ipynb">3. Load parameters for cell clustering (saved during <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocess">4. Preprocess</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cell-clustering">5. Cell clustering</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-and-train-cell-som">5.1: Visualize and train cell SOM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-cell-som-clusters">5.2: Assign cell SOM clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-cell-consensus-clustering">5.3 Run cell consensus clustering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">6. Visualize results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-adjustments-to-relabel-cell-meta-clusters">6.1 Interactive adjustments to relabel cell meta clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#quickstart">Quickstart</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-and-remapping-details">Selection and Remapping details</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#other-features-and-notes">Other features and notes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-cell-som-cluster-average-heatmap-over-channels-z-scored">6.2 Weighted cell SOM cluster average heatmap over channels (z-scored)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-cell-meta-cluster-average-heatmap-over-channels-z-scored">6.3 Weighted cell meta cluster average heatmap over channels (z-scored)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-cell-phenotype-maps">6.4 Generate cell phenotype maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-images-for-mantis-viewer">6.5 Save images for Mantis Viewer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamental-analysis">7.0 Fundamental Analysis</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="part-6-cluster-cells">
<h1>Part 6: Cluster cells.<a class="headerlink" href="#part-6-cluster-cells" title="Link to this heading">#</a></h1>
<p>In the following notebook you will continue the process of phenotyping cells by combining the pixel clustering with the segmentation features.  This is the “Pixie” project from the ark-analysis repo <a class="github reference external" href="https://github.com/angelolab/ark-analysis/tree/main">angelolab/ark-analysis</a></p>
<section id="import-packages">
<h2>1. Import packages.<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h2>
<section id="this-must-be-done-every-time-the-notebook-is-started-or-restarted">
<h3>*This must be done every time the notebook is started or restarted.<a class="headerlink" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted" title="Link to this heading">#</a></h3>
<p>NOTE: this notebook should be run after <code class="docutils literal notranslate"><span class="pre">2_Pixie_Cluster_Pixels.ipynb</span></code></p>
<div class="cell tag_import docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">feather</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">alpineer</span> <span class="kn">import</span> <span class="n">load_utils</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rc_file_defaults</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyFlowSOM</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">tifffile</span> <span class="kn">import</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">stackview</span>

<span class="kn">from</span> <span class="nn">ark.phenotyping</span> <span class="kn">import</span> <span class="p">(</span><span class="n">cell_cluster_utils</span><span class="p">,</span> <span class="n">cell_meta_clustering</span><span class="p">,</span>
                             <span class="n">cell_som_clustering</span><span class="p">,</span> <span class="n">weighted_channel_comp</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ark.utils</span> <span class="kn">import</span> <span class="n">data_utils</span><span class="p">,</span> <span class="n">plot_utils</span>
<span class="kn">from</span> <span class="nn">ark.utils.metacluster_remap_gui</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MetaClusterGui</span><span class="p">,</span>
                                             <span class="n">colormap_helper</span><span class="p">,</span>
                                             <span class="n">metaclusterdata_from_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">20</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="kn">import</span> <span class="nn">stackview</span>
<span class="ne">---&gt; </span><span class="mi">20</span> <span class="kn">from</span> <span class="nn">ark.phenotyping</span> <span class="kn">import</span> <span class="p">(</span><span class="n">cell_cluster_utils</span><span class="p">,</span> <span class="n">cell_meta_clustering</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>                              <span class="n">cell_som_clustering</span><span class="p">,</span> <span class="n">weighted_channel_comp</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="kn">from</span> <span class="nn">ark.utils</span> <span class="kn">import</span> <span class="n">data_utils</span><span class="p">,</span> <span class="n">plot_utils</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="kn">from</span> <span class="nn">ark.utils.metacluster_remap_gui</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MetaClusterGui</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>                                              <span class="n">colormap_helper</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>                                              <span class="n">metaclusterdata_from_files</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">KINTSUGI</span><span class="o">-</span><span class="n">docs</span>\<span class="n">src</span>\<span class="n">notebooks</span>\<span class="n">ark</span>\<span class="n">phenotyping</span>\<span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">11</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">from</span> <span class="nn">alpineer</span> <span class="kn">import</span> <span class="n">io_utils</span><span class="p">,</span> <span class="n">misc_utils</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="kn">from</span> <span class="nn">ark.analysis</span> <span class="kn">import</span> <span class="n">visualize</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="k">def</span> <span class="nf">compute_p2c_weighted_channel_avg</span><span class="p">(</span><span class="n">pixel_channel_avg</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">cell_counts</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>                                      <span class="n">fovs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixel_cluster_col</span><span class="o">=</span><span class="s1">&#39;pixel_meta_cluster_rename&#39;</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Compute the average marker expression for each cell weighted by pixel cluster</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">18</span><span class="sd">     This expression is weighted by the pixel SOM/meta cluster counts. So for each cell,</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span><span class="sd">             Returns the average marker expression for each cell in the dataset</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span><span class="sd">     &quot;&quot;&quot;</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">KINTSUGI</span><span class="o">-</span><span class="n">docs</span>\<span class="n">src</span>\<span class="n">notebooks</span>\<span class="n">ark</span>\<span class="n">analysis</span>\<span class="n">visualize</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">spatial_lda.visualization</span> <span class="k">as</span> <span class="nn">sv</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">alpineer</span> <span class="kn">import</span> <span class="n">misc_utils</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">from</span> <span class="nn">ark.utils.spatial_lda_utils</span> <span class="kn">import</span> <span class="n">make_plot_fn</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">miniforge3</span>\<span class="n">envs</span>\<span class="n">KINTSUGI</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">spatial_lda</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">.online_lda</span> <span class="kn">import</span> <span class="n">LatentDirichletAllocation</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">miniforge3</span>\<span class="n">envs</span>\<span class="n">KINTSUGI</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">spatial_lda</span>\<span class="n">online_lda</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">31</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="kn">from</span> <span class="nn">sklearn.decomposition._online_lda_fast</span> <span class="kn">import</span> <span class="p">(</span><span class="n">mean_change</span><span class="p">,</span> <span class="n">_dirichlet_expectation_1d</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>                                                     <span class="n">_dirichlet_expectation_2d</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="ne">---&gt; </span><span class="mi">31</span> <span class="n">EPS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span> <span class="k">def</span> <span class="nf">_update_doc_distribution</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">exp_topic_word_distr</span><span class="p">,</span> <span class="n">doc_topic_prior</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>                              <span class="n">max_iters</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span>                              <span class="n">mean_change_tol</span><span class="p">,</span> <span class="n">cal_sstats</span><span class="p">,</span> <span class="n">random_state</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;E-step: update document-topic distribution.</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">39</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">76</span><span class="sd">     &quot;&quot;&quot;</span>

<span class="nn">File ~\miniforge3\envs\KINTSUGI\lib\site-packages\numpy\__init__.py:353,</span> in <span class="ni">__getattr__</span><span class="nt">(attr)</span>
<span class="g g-Whitespace">    </span><span class="mi">348</span>     <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">349</span>         <span class="sa">f</span><span class="s2">&quot;In the future `np.</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">` will be defined as the &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">350</span>         <span class="s2">&quot;corresponding NumPy scalar.&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">__former_attrs__</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">353</span>     <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">__former_attrs__</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span> <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>     <span class="kn">import</span> <span class="nn">numpy.testing</span> <span class="k">as</span> <span class="nn">testing</span>

<span class="ne">AttributeError</span>: module &#39;numpy&#39; has no attribute &#39;float&#39;.
<span class="err">`</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="err">`</span> <span class="n">was</span> <span class="n">a</span> <span class="n">deprecated</span> <span class="n">alias</span> <span class="k">for</span> <span class="n">the</span> <span class="n">builtin</span> <span class="err">`</span><span class="nb">float</span><span class="err">`</span><span class="o">.</span> <span class="n">To</span> <span class="n">avoid</span> <span class="n">this</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">existing</span> <span class="n">code</span><span class="p">,</span> <span class="n">use</span> <span class="err">`</span><span class="nb">float</span><span class="err">`</span> <span class="n">by</span> <span class="n">itself</span><span class="o">.</span> <span class="n">Doing</span> <span class="n">this</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">modify</span> <span class="nb">any</span> <span class="n">behavior</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">safe</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">specifically</span> <span class="n">wanted</span> <span class="n">the</span> <span class="n">numpy</span> <span class="n">scalar</span> <span class="nb">type</span><span class="p">,</span> <span class="n">use</span> <span class="err">`</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="err">`</span> <span class="n">here</span><span class="o">.</span>
<span class="n">The</span> <span class="n">aliases</span> <span class="n">was</span> <span class="n">originally</span> <span class="n">deprecated</span> <span class="ow">in</span> <span class="n">NumPy</span> <span class="mf">1.20</span><span class="p">;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">details</span> <span class="ow">and</span> <span class="n">guidance</span> <span class="n">see</span> <span class="n">the</span> <span class="n">original</span> <span class="n">release</span> <span class="n">note</span> <span class="n">at</span><span class="p">:</span>
    <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">numpy</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">devdocs</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="mf">1.20.0</span><span class="o">-</span><span class="n">notes</span><span class="o">.</span><span class="n">html</span><span class="c1">#deprecations</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="define-directory-paths">
<h2>2. Define directory paths.<a class="headerlink" href="#define-directory-paths" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>*This must be done every time the notebook is started or restarted.<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="cell tag_base_dir docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Users/smith6jt/KINTSUGI/data/1904_CC2B_Segmentation&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation folder is </span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="load-parameters-for-cell-clustering-saved-during-2-cluster-pixels-ipynb">
<h2>3. Load parameters for cell clustering (saved during <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>)<a class="headerlink" href="#load-parameters-for-cell-clustering-saved-during-2-cluster-pixels-ipynb" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">cell_clustering_params_name</span></code> should be <code class="docutils literal notranslate"><span class="pre">cell_clustering_params.json</span></code> contained in <code class="docutils literal notranslate"><span class="pre">{pixel_cluster_prefix}_pixel_output_dir</span></code>. Make sure to set <code class="docutils literal notranslate"><span class="pre">base_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">pixel_output_dir</span></code> to the same value used in <code class="docutils literal notranslate"><span class="pre">2_Pixie_Cluster_Pixels.ipynb</span></code>.</p>
<p>NOTE: <code class="docutils literal notranslate"><span class="pre">{pixel_cluster_prefix}</span></code> is set in <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>. If you did not explicity set a <code class="docutils literal notranslate"><span class="pre">{pixel_cluster_prefix}</span></code> in <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>, the prefix defaults to the timestamp of the run. Please check the run directory (<code class="docutils literal notranslate"><span class="pre">base_dir</span></code> as set in <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>) to see the prefix that was used.</p>
<div class="cell tag_dir_set docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the name of the folder containing the pixel cluster data</span>
<span class="n">pixel_output_dir</span> <span class="o">=</span> <span class="s1">&#39;1904CC2B28_pixel_output_dir&#39;</span>

<span class="c1"># define the name of the cell clustering params file</span>
<span class="n">cell_clustering_params_name</span> <span class="o">=</span> <span class="s1">&#39;cell_clustering_params.json&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>The following params are loaded:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fovs</span></code>: subset of fovs used for pixel clustering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">channels</span></code>: subset of channels used for pixel clustering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tiff_dir</span></code>: path to the directory containing your imaging data. Images should be single-channel TIFFs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">img_sub_folder</span></code>: if <code class="docutils literal notranslate"><span class="pre">tiff_dir</span></code> contains an additional subfolder structure, set to the appropriate folder name (or <code class="docutils literal notranslate"><span class="pre">None</span></code> if no such structure present)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">segmentation_dir</span></code>: path to the directory containing your segmented images (can be generated from <code class="docutils literal notranslate"><span class="pre">1_Segment_Image_Data.ipynb</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">seg_suffix</span></code>: suffix plus the file extension of the segmented images for each FOV</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pixel_data_dir</span></code>: name of the directory containing pixel data with the pixel SOM and meta cluster assignments</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pc_chan_avg_som_cluster_name</span></code>: name of the file containing the average channel expression per pixel SOM cluster, used for the visualization of weighted channel average per cell</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pc_chan_avg_meta_cluster_name</span></code>: name of the file containing the average channel expression per pixel meta cluster, used for the visualization of weighted channel average per cell</p></li>
</ul>
<p>Additionally, define the following parameter:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cell_table_path</span></code>: path to the cell table where each row in the table is one cell, must contain <code class="docutils literal notranslate"><span class="pre">fov</span></code>, <code class="docutils literal notranslate"><span class="pre">label</span></code>, and <code class="docutils literal notranslate"><span class="pre">cell_size</span></code> columns. Can be created by <code class="docutils literal notranslate"><span class="pre">1_Segment_Image_Data.ipynb</span></code>, should be placed in <code class="docutils literal notranslate"><span class="pre">segmentation_dir</span></code> by default. You can use either the normalized or arcsinh versions (only columns that are used are <code class="docutils literal notranslate"><span class="pre">fov</span></code>, <code class="docutils literal notranslate"><span class="pre">label</span></code>, and <code class="docutils literal notranslate"><span class="pre">cell_size</span></code>).</p></li>
</ul>
<div class="cell tag_param_load docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the params</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">pixel_output_dir</span><span class="p">,</span> <span class="n">cell_clustering_params_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">cell_clustering_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    
<span class="c1"># assign the params to variables</span>
<span class="n">fovs</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;fovs&#39;</span><span class="p">]</span>
<span class="n">channels</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span>
<span class="n">tiff_dir</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;tiff_dir&#39;</span><span class="p">]</span>
<span class="n">img_sub_folder</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;img_sub_folder&#39;</span><span class="p">]</span>
<span class="n">segmentation_dir</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;segmentation_dir&#39;</span><span class="p">]</span>
<span class="n">seg_suffix</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;seg_suffix&#39;</span><span class="p">]</span>
<span class="n">pixel_data_dir</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;pixel_data_dir&#39;</span><span class="p">]</span>
<span class="n">pc_chan_avg_som_cluster_name</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;pc_chan_avg_som_cluster_name&#39;</span><span class="p">]</span>
<span class="n">pc_chan_avg_meta_cluster_name</span> <span class="o">=</span> <span class="n">cell_clustering_params</span><span class="p">[</span><span class="s1">&#39;pc_chan_avg_meta_cluster_name&#39;</span><span class="p">]</span>

<span class="c1"># define the cell table path</span>
<span class="n">cell_table_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;segmentation&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_table&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_table_size_normalized.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="preprocess">
<h2>4. Preprocess<a class="headerlink" href="#preprocess" title="Link to this heading">#</a></h2>
<p>Set a prefix to be applied to all data directories/files created during cell clustering. If the prefix is not set, a default of the datetime at the start of the run is used.</p>
<div class="cell tag_cluster_prefix docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># explicitly set cell_cluster_prefix to override datetime default</span>
<span class="n">cell_cluster_prefix</span> <span class="o">=</span> <span class="s1">&#39;1904CC2B28&#39;</span>

<span class="k">if</span> <span class="n">cell_cluster_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cell_cluster_prefix</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following folders/files will be created with names prefixed by <code class="docutils literal notranslate"><span class="pre">cell_cluster_prefix</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cell_output_dir</span></code>: directory name where the cell clustering outputs are stored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_som_weights_name</span></code>: file name to store the cell SOM weights</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cluster_counts_name</span></code>: file name to store the counts of each pixel cluster per cell</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cluster_counts_size_norm_name</span></code>: same as above, except with each value normalized by the respective cell’s size. The data will also contain the cell SOM and meta cluster labels assigned.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weighted_cell_channel_name</span></code>: file name to store the weighted cell channel expression for each cell. Refer to <a href=https://ark-analysis.readthedocs.io/en/latest/_markdown/ark.phenotyping.html#ark.phenotyping.cell_cluster_utils.compute_p2c_weighted_channel_avg>cell channel weighting docs</a> for how the weighting is computed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_som_cluster_count_avg_name</span></code>: file name to store the average number of pixel clusters per cell SOM cluster</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_count_avg_name</span></code>: same as above for cell meta clusters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_som_cluster_channel_avg_name</span></code>: file name to store the average weighted channel expression per cell SOM cluster</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_channel_avg_name</span></code>: same as above for cell meta clusters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_remap_name</span></code>: file name to store the SOM cluster to meta cluster manual mappings created using the GUI below</p></li>
</ul>
<div class="cell tag_cell_cluster_files docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the base output cell folder</span>
<span class="n">cell_output_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_cell_output_dir&#39;</span> <span class="o">%</span> <span class="n">cell_cluster_prefix</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">))</span>
    
<span class="c1"># define the paths to cell clustering files, explicitly set the variables to use custom names</span>
<span class="n">cell_som_weights_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_som_weights.feather&#39;</span><span class="p">)</span>
<span class="n">cluster_counts_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cluster_counts.feather&#39;</span><span class="p">)</span>
<span class="n">cluster_counts_size_norm_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cluster_counts_size_norm.feather&#39;</span><span class="p">)</span>
<span class="n">weighted_cell_channel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;weighted_cell_channel.feather&#39;</span><span class="p">)</span>
<span class="n">cell_som_cluster_count_avg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_som_cluster_count_avg.csv&#39;</span><span class="p">)</span>
<span class="n">cell_meta_cluster_count_avg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_meta_cluster_count_avg.csv&#39;</span><span class="p">)</span>
<span class="n">cell_som_cluster_channel_avg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_som_cluster_channel_avg.csv&#39;</span><span class="p">)</span>
<span class="n">cell_meta_cluster_channel_avg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_meta_cluster_channel_avg.csv&#39;</span><span class="p">)</span>
<span class="n">cell_meta_cluster_remap_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s1">&#39;cell_meta_cluster_mapping.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Additionally, define the following variable:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pixel_cluster_col</span></code>: whether to use the pixel SOM or meta cluster counts for cell clustering. Must be either <code class="docutils literal notranslate"><span class="pre">'pixel_som_cluster'</span></code> or <code class="docutils literal notranslate"><span class="pre">'pixel_meta_cluster_rename'</span></code>. Note that if you did not explicitly rename your pixel meta clusters in <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>, the default numeric names will be used.</p></li>
</ul>
<div class="cell tag_pixel_cluster_col docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the type of pixel cluster to aggregate on</span>
<span class="n">pixel_cluster_col</span> <span class="o">=</span> <span class="s1">&#39;pixel_meta_cluster_rename&#39;</span>

<span class="c1"># depending on which pixel_cluster_col is selected, choose the pixel channel average table accordingly</span>
<span class="k">if</span> <span class="n">pixel_cluster_col</span> <span class="o">==</span> <span class="s1">&#39;pixel_som_cluster&#39;</span><span class="p">:</span>
    <span class="n">pc_chan_avg_name</span> <span class="o">=</span> <span class="n">pc_chan_avg_som_cluster_name</span>
<span class="k">elif</span> <span class="n">pixel_cluster_col</span> <span class="o">==</span> <span class="s1">&#39;pixel_meta_cluster_rename&#39;</span><span class="p">:</span>
    <span class="n">pc_chan_avg_name</span> <span class="o">=</span> <span class="n">pc_chan_avg_meta_cluster_name</span>
</pre></div>
</div>
</div>
</div>
<p>Generate the input data for the cell SOM. This computes the counts of each pixel cluster per cell, both raw and normalized by cell size.</p>
<p>If both datasets already exist, load them in instead.</p>
<p>The next cell decompresses the data from the end of the Segmentation notebook.  If you did not compress the data at that point, skip this cell and proceed to the next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">zstandard</span> <span class="k">as</span> <span class="nn">zstd</span>

<span class="c1"># Path to the compressed CSV file</span>
<span class="n">compressed_file_path</span> <span class="o">=</span> <span class="n">cell_table_path</span>

<span class="c1"># Decompress and read the CSV directly</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">compressed_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">compressed_file</span><span class="p">:</span>
    <span class="n">dctx</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdDecompressor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">dctx</span><span class="o">.</span><span class="n">stream_reader</span><span class="p">(</span><span class="n">compressed_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">decompressed_file</span><span class="p">:</span>
        <span class="c1"># Read decompressed file into pandas dataframe</span>
        <span class="n">cell_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">decompressed_file</span><span class="p">)</span>
        <span class="n">cell_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">cell_table_path</span><span class="p">,</span>
                                  <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Now &#39;cell_table&#39; contains the decompressed CSV data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_generate_som_input_data docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_name</span><span class="p">))</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">)):</span>
    <span class="c1"># load the data if it exists</span>
    <span class="n">cluster_counts</span> <span class="o">=</span> <span class="n">feather</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_name</span><span class="p">))</span>
    <span class="n">cluster_counts_size_norm</span> <span class="o">=</span> <span class="n">feather</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># generate the preprocessed data </span>
    <span class="n">cluster_counts</span><span class="p">,</span> <span class="n">cluster_counts_size_norm</span> <span class="o">=</span> <span class="n">cell_cluster_utils</span><span class="o">.</span><span class="n">create_c2pc_data</span><span class="p">(</span>
        <span class="n">fovs</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">pixel_data_dir</span><span class="p">),</span> <span class="n">cell_table_path</span><span class="p">,</span> <span class="n">pixel_cluster_col</span>
    <span class="p">)</span>

    <span class="c1"># write both unnormalized and normalized input data for reference</span>
    <span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
        <span class="n">cluster_counts</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_name</span><span class="p">),</span>
        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
    <span class="p">)</span>
    <span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
        <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">),</span>
        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
    <span class="p">)</span>
    
<span class="c1"># define the count columns found in cluster_counts_norm</span>
<span class="n">cell_som_cluster_cols</span> <span class="o">=</span> <span class="n">cluster_counts_size_norm</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">regex</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pixel_cluster_col</span><span class="si">}</span><span class="s1">.*&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>Generate the weighted cell channel expression file. This data will be needed to compute the weighted average channel expression per cell cluster (the data stored in <code class="docutils literal notranslate"><span class="pre">cell_som_cluster_channel_avg_name</span></code> and <code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_channel_avg_name</span></code>). See documentation of <code class="docutils literal notranslate"><span class="pre">compute_p2c_weighted_channel_avg</span></code> for how weighted cell channel average is computed: <a href=https://ark-analysis.readthedocs.io/en/latest/_markdown/ark.phenotyping.html#ark.phenotyping.cell_cluster_utils.compute_p2c_weighted_channel_avg>cell channel weighting docs</a>.</p>
<p>If this file already exists, skip this step.</p>
<div class="cell tag_generate_weighted_channel_data docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># depending on which pixel_cluster_col is selected, choose the pixel channel average table accordingly</span>
<span class="k">if</span> <span class="n">pixel_cluster_col</span> <span class="o">==</span> <span class="s1">&#39;pixel_som_cluster&#39;</span><span class="p">:</span>
    <span class="n">pc_chan_avg_name</span> <span class="o">=</span> <span class="n">pc_chan_avg_som_cluster_name</span>
<span class="k">elif</span> <span class="n">pixel_cluster_col</span> <span class="o">==</span> <span class="s1">&#39;pixel_meta_cluster_rename&#39;</span><span class="p">:</span>
    <span class="n">pc_chan_avg_name</span> <span class="o">=</span> <span class="n">pc_chan_avg_meta_cluster_name</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">weighted_cell_channel_name</span><span class="p">)):</span>
    <span class="c1"># generate the weighted cell channel expression data</span>
    <span class="n">pixel_channel_avg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">pc_chan_avg_name</span><span class="p">))</span>
    <span class="n">weighted_cell_channel</span> <span class="o">=</span> <span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">compute_p2c_weighted_channel_avg</span><span class="p">(</span>
        <span class="n">pixel_channel_avg</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">,</span>
        <span class="n">cluster_counts</span><span class="p">,</span>
        <span class="n">fovs</span><span class="o">=</span><span class="n">fovs</span><span class="p">,</span>
        <span class="n">pixel_cluster_col</span><span class="o">=</span><span class="n">pixel_cluster_col</span>
    <span class="p">)</span>

    <span class="c1"># write the data to weighted_cell_channel_name</span>
    <span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
        <span class="n">weighted_cell_channel</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">weighted_cell_channel_name</span><span class="p">),</span>
        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cell-clustering">
<h2>5. Cell clustering<a class="headerlink" href="#cell-clustering" title="Link to this heading">#</a></h2>
<section id="visualize-and-train-cell-som">
<h3>5.1: Visualize and train cell SOM<a class="headerlink" href="#visualize-and-train-cell-som" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_cell_som_training</span><span class="p">(</span>
    <span class="n">fovs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">cell_table_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
    <span class="n">cell_som_input_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
    <span class="n">channel_vis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">xdim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
    <span class="n">ydim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">num_passes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">lr_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">lr_end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">show_plots</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>


    <span class="n">cell_data</span> <span class="o">=</span> <span class="n">cell_som_input_data</span><span class="p">[</span><span class="n">cell_som_input_data</span><span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fovs</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cell_data</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_size&#39;</span><span class="p">])</span>
    <span class="n">cell_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">cell_table_path</span><span class="p">)</span>
    <span class="n">filtered_rows</span> <span class="o">=</span> <span class="n">cell_table</span><span class="p">[</span><span class="n">cell_table</span><span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fovs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">centroid_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">filtered_rows</span><span class="p">])</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">cell_data</span><span class="p">[</span><span class="n">cell_som_cluster_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">xdim</span> <span class="o">*</span> <span class="n">ydim</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiff_dir</span><span class="p">,</span> <span class="s2">&quot;fov1&quot;</span><span class="p">,</span> <span class="n">channel_vis</span><span class="o">+</span><span class="s2">&quot;.tif&quot;</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">))</span>
    <span class="n">node_cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="n">pbar_filesave</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Percent&quot;</span><span class="p">,</span>
                    <span class="n">bar_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{l_bar}{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">]&#39;</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">scatter_frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rlen_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_passes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># print(f&quot;Training for rlen={rlen_iter}&quot;)</span>
        <span class="n">som</span> <span class="o">=</span> <span class="n">pyFlowSOM</span><span class="o">.</span><span class="n">som</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">rlen_iter</span><span class="p">,</span> <span class="n">alpha_range</span><span class="o">=</span><span class="p">(</span><span class="n">lr_start</span><span class="p">,</span> <span class="n">lr_end</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">clusters</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">pyFlowSOM</span><span class="o">.</span><span class="n">map_data_to_nodes</span><span class="p">(</span><span class="n">som</span><span class="p">,</span> <span class="n">train_data</span><span class="p">)</span>

        <span class="n">cell_data</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clusters</span>
        <span class="n">df_mean</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="c1"># Create a GridSpec with 3 rows and 1 column</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">4.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">node_cmap</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original Image: </span><span class="si">{</span><span class="n">channel_vis</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">centroid_data</span><span class="p">[</span><span class="s1">&#39;centroid-1_nuclear&#39;</span><span class="p">],</span> <span class="n">centroid_data</span><span class="p">[</span><span class="s1">&#39;centroid-0_nuclear&#39;</span><span class="p">],</span> 
                                <span class="n">c</span><span class="o">=</span><span class="n">cell_data</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
                                <span class="n">cmap</span><span class="o">=</span><span class="n">node_cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SOM Iteration </span><span class="si">{</span><span class="n">rlen_iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">node_cmap</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SOM Visualization for rlen=(rlen=</span><span class="si">{</span><span class="n">rlen_iter</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">g</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">df_mean</span><span class="p">,</span> <span class="n">z_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;vlag&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                        <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="n">node_cmap</span><span class="p">)</span>
        <span class="n">heatmap_data</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">data2d</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">heatmap_data</span><span class="p">,</span> 
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;vlag&quot;</span><span class="p">,</span>
                <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">xticklabels</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">data2d</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="n">yticklabels</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">data2d</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># axes[2].set_aspect(image.shape[1] / image.shape[0])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster heatmap for rlen=</span><span class="si">{</span><span class="n">rlen_iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># fig.tight_layout()</span>

        <span class="n">canvas</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()</span> <span class="o">*</span> <span class="n">fig</span><span class="o">.</span><span class="n">dpi</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">buffer_rgba</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">scatter_frame</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="n">scatter_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">pbar_filesave</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_passes</span><span class="p">))</span>

    <span class="n">pbar_filesave</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">scatter_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scatter_frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter_stack</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fov_vis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fov6&#39;</span><span class="p">]</span>
<span class="n">channel_vis</span> <span class="o">=</span> <span class="s1">&#39;SMActin&#39;</span>
<span class="n">xdim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ydim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_passes</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">lr_start</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">lr_end</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">visualize_cell_som_training</span><span class="p">(</span>
    <span class="n">fovs</span><span class="o">=</span><span class="n">fov_vis</span><span class="p">,</span>
    <span class="n">cell_table_path</span><span class="o">=</span><span class="n">cell_table_path</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span><span class="p">,</span> 
    <span class="n">cell_som_input_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span> 
    <span class="n">xdim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
    <span class="n">ydim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
    <span class="n">lr_start</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> 
    <span class="n">lr_end</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
    <span class="n">num_passes</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
    <span class="n">channel_vis</span> <span class="o">=</span> <span class="n">channel_vis</span><span class="p">,</span>
    <span class="n">show_plots</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> widget
<span class="n">stackview</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Train the cell SOM on the size-normalized number of pixel clusters per cell (the data stored in <code class="docutils literal notranslate"><span class="pre">cluster_counts_size_norm_name</span></code>). Training is done using the self-organizing map (SOM) algorithm. Note that each of the pixel SOM/meta cluster columns are normalized by their 99.9% value prior to training.</p>
<p>For a full set of parameters you can customize for <code class="docutils literal notranslate"><span class="pre">train_cell_som</span></code>, please consult <a href=https://ark-analysis.readthedocs.io/en/latest/_markdown/ark.phenotyping.html#ark.phenotyping.cell_cluster_utils.train_cell_som>cell training docs</a>.</p>
<div class="cell tag_train_cell_som docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the cell SOM weights</span>
<span class="n">cell_pysom</span> <span class="o">=</span> <span class="n">cell_som_clustering</span><span class="o">.</span><span class="n">train_cell_som</span><span class="p">(</span>
    <span class="n">fovs</span><span class="p">,</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cell_table_path</span><span class="o">=</span><span class="n">cell_table_path</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span><span class="p">,</span>
    <span class="n">cell_som_input_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">som_weights_name</span><span class="o">=</span><span class="n">cell_som_weights_name</span><span class="p">,</span>
    <span class="n">num_passes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-cell-som-clusters">
<h3>5.2: Assign cell SOM clusters<a class="headerlink" href="#assign-cell-som-clusters" title="Link to this heading">#</a></h3>
<p>Use the weights learned from <code class="docutils literal notranslate"><span class="pre">train_cell_som</span></code> to assign cell clusters to the dataset. Note that this is done on the size-normalized pixel cluster counts table. As with <code class="docutils literal notranslate"><span class="pre">train_pixel_som</span></code>, each of the columns are normalized by their 99.9% value prior to assigning a cell SOM cluster label.</p>
<p><code class="docutils literal notranslate"><span class="pre">generate_som_avg_files</span></code> will compute the average number of pixel clusters per cell SOM cluster, as well as the number of cells in each cell SOM cluster (the data placed in <code class="docutils literal notranslate"><span class="pre">cell_som_cluster_count_avg_name</span></code>). This is needed for cell consensus clustering.</p>
<div class="cell tag_cluster_cell_data docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use cell SOM weights to assign cell clusters</span>
<span class="n">cluster_counts_size_norm</span> <span class="o">=</span> <span class="n">cell_som_clustering</span><span class="o">.</span><span class="n">cluster_cells</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cell_pysom</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span>
<span class="p">)</span>

<span class="c1"># intermediate saving of cell data with SOM labels assigned</span>
<span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">),</span>
    <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
<span class="p">)</span>

<span class="c1"># generate the SOM cluster summary files</span>
<span class="n">cell_som_clustering</span><span class="o">.</span><span class="n">generate_som_avg_files</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span><span class="p">,</span>
    <span class="n">cell_som_expr_col_avg_name</span><span class="o">=</span><span class="n">cell_som_cluster_count_avg_name</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-cell-consensus-clustering">
<h3>5.3 Run cell consensus clustering<a class="headerlink" href="#run-cell-consensus-clustering" title="Link to this heading">#</a></h3>
<p>Use consensus hierarchical clustering to cluster cell SOM clusters into a user-defined number of meta clusters. The consensus clusters are trained on the average number of pixel clusters across all cell SOM clusters (the data stored in <code class="docutils literal notranslate"><span class="pre">cell_som_cluster_count_avg_name</span></code>). These values are z-scored and capped at the value specified in the <code class="docutils literal notranslate"><span class="pre">cap</span></code> argument prior to consensus clustering. This helps improve meta clustering performance.</p>
<p>After consensus clustering, the following are computed by <code class="docutils literal notranslate"><span class="pre">generate_meta_avg_files</span></code>:</p>
<ul class="simple">
<li><p>The average number of pixel clusters across all cell meta clusters, and the number of cells per meta cluster (the data placed in <code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_count_avg_name</span></code>)</p></li>
<li><p>The meta cluster mapping for each cell SOM cluster in <code class="docutils literal notranslate"><span class="pre">cell_som_cluster_count_avg_name</span></code> (data is resaved, same data except with an associated meta cluster column)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">generate_wc_avg_files</span></code> also creates the following:</p>
<ul class="simple">
<li><p>The weighted channel average across all cell clusters (the data placed in <code class="docutils literal notranslate"><span class="pre">cell_som_cluster_channel_avg_name</span></code> and <code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_channel_avg_name</span></code>). This will be done for both <code class="docutils literal notranslate"><span class="pre">'cell_som_cluster'</span></code> and <code class="docutils literal notranslate"><span class="pre">'cell_meta_cluster'</span></code>.</p></li>
</ul>
<p>For a full set of parameters you can customize for <code class="docutils literal notranslate"><span class="pre">cell_consensus_cluster</span></code>, please consult <a href=https://ark-analysis.readthedocs.io/en/latest/_markdown/ark.phenotyping.html#ark.phenotyping.cell_cluster_utils.cell_consensus_cluster>cell consensus clustering docs</a></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_k</span></code>: the number of consensus clusters desired</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cap</span></code>: used to clip z-scored values prior to consensus clustering (in the range <code class="docutils literal notranslate"><span class="pre">[-cap,</span> <span class="pre">cap]</span></code>)</p></li>
</ul>
<div class="cell tag_cell_consensus_cluster tag_cell_mantis_project docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_k</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">cap</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># run hierarchical clustering using average count of pixel clusters per cell SOM cluster</span>
<span class="n">cell_cc</span><span class="p">,</span> <span class="n">cluster_counts_size_norm</span> <span class="o">=</span> <span class="n">cell_meta_clustering</span><span class="o">.</span><span class="n">cell_consensus_cluster</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span><span class="p">,</span>
    <span class="n">cell_som_input_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_som_expr_col_avg_name</span><span class="o">=</span><span class="n">cell_som_cluster_count_avg_name</span><span class="p">,</span>
    <span class="n">max_k</span><span class="o">=</span><span class="n">max_k</span><span class="p">,</span>
    <span class="n">cap</span><span class="o">=</span><span class="n">cap</span>
<span class="p">)</span>

<span class="c1"># intermediate saving of cell data with SOM and meta labels assigned</span>
<span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">),</span>
    <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
<span class="p">)</span>

<span class="c1"># generate the meta cluster summary files</span>
<span class="n">cell_meta_clustering</span><span class="o">.</span><span class="n">generate_meta_avg_files</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cell_cc</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="o">=</span><span class="n">cell_som_cluster_cols</span><span class="p">,</span>
    <span class="n">cell_som_input_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_som_expr_col_avg_name</span><span class="o">=</span><span class="n">cell_som_cluster_count_avg_name</span><span class="p">,</span>
    <span class="n">cell_meta_expr_col_avg_name</span><span class="o">=</span><span class="n">cell_meta_cluster_count_avg_name</span>
<span class="p">)</span>

<span class="c1"># generate weighted channel summary files</span>
<span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">generate_wc_avg_files</span><span class="p">(</span>
    <span class="n">fovs</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">,</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cell_cc</span><span class="p">,</span>
    <span class="n">cell_som_input_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">weighted_cell_channel_name</span><span class="o">=</span><span class="n">weighted_cell_channel_name</span><span class="p">,</span>
    <span class="n">cell_som_cluster_channel_avg_name</span><span class="o">=</span><span class="n">cell_som_cluster_channel_avg_name</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_channel_avg_name</span><span class="o">=</span><span class="n">cell_meta_cluster_channel_avg_name</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="visualize-results">
<h2>6. Visualize results<a class="headerlink" href="#visualize-results" title="Link to this heading">#</a></h2>
<section id="interactive-adjustments-to-relabel-cell-meta-clusters">
<h3>6.1 Interactive adjustments to relabel cell meta clusters<a class="headerlink" href="#interactive-adjustments-to-relabel-cell-meta-clusters" title="Link to this heading">#</a></h3>
<p>The visualization shows the z-scored average pixel cluster count expression per cell SOM and meta cluster. The heatmaps are faceted by cell SOM clusters on the left and cell meta clusters on the right.</p>
<section id="quickstart">
<h4>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Select</strong>: Left Click</p></li>
<li><p><strong>Remap</strong>: <strong>New metacluster button</strong> or Right Click</p></li>
<li><p><strong>Edit Metacluster Name</strong>: Textbox at bottom right of the heatmaps.</p></li>
</ul>
</section>
<section id="selection-and-remapping-details">
<h4>Selection and Remapping details<a class="headerlink" href="#selection-and-remapping-details" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>To select a SOM cluster, click on its respective position in the <strong>selected</strong> bar. Click on it again to deselect.</p></li>
<li><p>To select a meta cluster, click on its corresponding color in the <strong>metacluster</strong> bar. Click on it again to deselect.</p></li>
<li><p>To remap the selected clusters, click the <strong>New metacluster</strong> button (alternatively, right click anywhere). Note that remapping an entire metacluster deletes it.</p></li>
<li><p>To clear the selected SOM/meta clusters, use the <strong>Clear Selection</strong> button.</p></li>
<li><p><strong>After remapping a meta cluster, make sure to deselect the newly created one to prevent unwanted combinations.</strong></p></li>
</ul>
</section>
<section id="other-features-and-notes">
<h4>Other features and notes<a class="headerlink" href="#other-features-and-notes" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>You will likely need to zoom out to see the entire visualization. To toggle Zoom, use Ctrl -/Ctrl + on Windows or ⌘ +/⌘ - on Mac.</p></li>
<li><p>The bars at the top show the number of cells in each SOM cluster.</p></li>
<li><p>The text box at the bottom right allows you to rename a particular meta cluster. This can be useful as remapping may cause inconsistent numbering. <strong>You cannot use the same name for different meta clusters; doing so will cause the next step to fail.</strong></p></li>
<li><p>Adjust the z-score limit using the slider on the bottom left to adjust your dynamic range.</p></li>
<li><p>When meta clusters are combined or a meta cluster is renamed, the change is immediately saved to <code class="docutils literal notranslate"><span class="pre">cell_meta_cluster_remap_name</span></code>.</p></li>
<li><p>You won’t be able to advance until you’ve clicked <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">metacluster</span></code> or renamed a meta cluster at least once. If you do not want to make changes, just click <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">metacluster</span></code> to trigger a save before continuing.</p></li>
</ul>
<div class="cell tag_cell_interactive docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> widget
<span class="n">rc_file_defaults</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

<span class="n">cell_mcd</span> <span class="o">=</span> <span class="n">metaclusterdata_from_files</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_som_cluster_count_avg_name</span><span class="p">),</span>
    <span class="n">cluster_type</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">prefix_trim</span><span class="o">=</span><span class="n">pixel_cluster_col</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
<span class="p">)</span>
<span class="n">cell_mcd</span><span class="o">.</span><span class="n">output_mapping_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_remap_name</span><span class="p">)</span>
<span class="n">cell_mcg</span> <span class="o">=</span> <span class="n">MetaClusterGui</span><span class="p">(</span><span class="n">cell_mcd</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Relabel the cell meta clusters using the mapping, and recompute the meta cluster average files with the new meta cluster names.</p>
<div class="cell tag_cell_apply_remap docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rename the meta cluster values in the cell dataset</span>
<span class="n">cluster_counts_size_norm</span> <span class="o">=</span> <span class="n">cell_meta_clustering</span><span class="o">.</span><span class="n">apply_cell_meta_cluster_remapping</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_remap_name</span>
<span class="p">)</span>

<span class="c1"># intermediate saving of cell data with SOM, raw meta, and renamed meta labels assigned</span>
<span class="n">feather</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cluster_counts_size_norm_name</span><span class="p">),</span>
    <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;uncompressed&#39;</span>
<span class="p">)</span>

<span class="c1"># recompute the mean column expression per meta cluster and apply these new names to the SOM cluster average data</span>
<span class="n">cell_meta_clustering</span><span class="o">.</span><span class="n">generate_remap_avg_count_files</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_remap_name</span><span class="p">,</span>
    <span class="n">cell_som_cluster_cols</span><span class="p">,</span>
    <span class="n">cell_som_cluster_count_avg_name</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_count_avg_name</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># recompute the mean weighted channel expression per meta cluster and apply these new names to the SOM channel average data</span>
<span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">generate_remap_avg_wc_files</span><span class="p">(</span>
    <span class="n">fovs</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">,</span>
    <span class="n">base_dir</span><span class="p">,</span>
    <span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_remap_name</span><span class="p">,</span>
    <span class="n">weighted_cell_channel_name</span><span class="p">,</span>
    <span class="n">cell_som_cluster_channel_avg_name</span><span class="p">,</span>
    <span class="n">cell_meta_cluster_channel_avg_name</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Generate the color scheme returned by the interactive reclustering process. This will be for visualizing the weighted channel average heatmaps and the cell phenotype maps.</p>
<div class="cell tag_cell_cmap_gen docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_cmap</span><span class="p">,</span> <span class="n">renamed_cmap</span> <span class="o">=</span> <span class="n">colormap_helper</span><span class="o">.</span><span class="n">generate_meta_cluster_colormap_dict</span><span class="p">(</span>
    <span class="n">cell_mcd</span><span class="o">.</span><span class="n">output_mapping_filename</span><span class="p">,</span>
    <span class="n">cell_mcg</span><span class="o">.</span><span class="n">im_cl</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
    <span class="n">cluster_type</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="weighted-cell-som-cluster-average-heatmap-over-channels-z-scored">
<h3>6.2 Weighted cell SOM cluster average heatmap over channels (z-scored)<a class="headerlink" href="#weighted-cell-som-cluster-average-heatmap-over-channels-z-scored" title="Link to this heading">#</a></h3>
<div class="cell tag_cell_som_heatmap docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">generate_weighted_channel_avg_heatmap</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_som_cluster_channel_avg_name</span><span class="p">),</span>
    <span class="s1">&#39;cell_som_cluster&#39;</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">,</span>
    <span class="n">raw_cmap</span><span class="p">,</span>
    <span class="n">renamed_cmap</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="weighted-cell-meta-cluster-average-heatmap-over-channels-z-scored">
<h3>6.3 Weighted cell meta cluster average heatmap over channels (z-scored)<a class="headerlink" href="#weighted-cell-meta-cluster-average-heatmap-over-channels-z-scored" title="Link to this heading">#</a></h3>
<div class="cell tag_cell_meta_heatmap docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weighted_channel_comp</span><span class="o">.</span><span class="n">generate_weighted_channel_avg_heatmap</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_channel_avg_name</span><span class="p">),</span>
    <span class="s1">&#39;cell_meta_cluster_rename&#39;</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">,</span>
    <span class="n">raw_cmap</span><span class="p">,</span>
    <span class="n">renamed_cmap</span><span class="p">,</span>
    <span class="n">center_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">min_val</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">max_val</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generate-cell-phenotype-maps">
<h3>6.4 Generate cell phenotype maps<a class="headerlink" href="#generate-cell-phenotype-maps" title="Link to this heading">#</a></h3>
<p>Generate cell phenotype maps, in which each pixel in the image corresponds to its cell meta cluster. Run this cell if you wish to create cell cluster mask images for downstream analysis.</p>
<div class="cell tag_cell_overlay_fovs docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select fovs to display</span>
<span class="n">subset_cell_fovs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fov0&#39;</span><span class="p">,</span> <span class="s1">&#39;fov1&#39;</span><span class="p">,</span> <span class="s1">&#39;fov2&#39;</span><span class="p">,</span> <span class="s1">&#39;fov3&#39;</span><span class="p">]</span>
<span class="c1"># , &#39;fov4&#39;, &#39;fov5&#39;, &#39;fov6&#39;, &#39;fov7&#39;, &#39;fov8&#39;, &#39;fov9&#39;, &#39;fov10&#39;, &#39;fov11&#39;, &#39;fov12&#39;, &#39;fov13&#39;, &#39;fov14&#39;, &#39;fov15&#39;, &#39;fov16&#39;, &#39;fov17&#39;, &#39;fov18&#39;, &#39;fov19&#39;, &#39;fov20&#39;, &#39;fov21&#39;,&#39;fov22&#39;, &#39;fov23&#39;]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_cell_mask_gen_save docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate and save the cell cluster masks for each fov in subset_cell_fovs</span>
<span class="n">data_utils</span><span class="o">.</span><span class="n">generate_and_save_cell_cluster_masks</span><span class="p">(</span>
    <span class="n">fovs</span><span class="o">=</span><span class="n">subset_cell_fovs</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">),</span>
    <span class="n">seg_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">segmentation_dir</span><span class="p">),</span>
    <span class="n">cell_data</span><span class="o">=</span><span class="n">cluster_counts_size_norm</span><span class="p">,</span>
    <span class="n">cluster_id_to_name_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_remap_name</span><span class="p">),</span>
    <span class="n">seg_suffix</span><span class="o">=</span><span class="n">seg_suffix</span><span class="p">,</span>
    <span class="n">sub_dir</span><span class="o">=</span><span class="s1">&#39;cell_masks&#39;</span><span class="p">,</span>
    <span class="n">name_suffix</span><span class="o">=</span><span class="s1">&#39;_cell_mask&#39;</span><span class="p">,</span>
    <span class="n">cell_cluster_col</span><span class="o">=</span><span class="s1">&#39;cell_meta_cluster&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Save the colored cell masks for each FOV in <code class="docutils literal notranslate"><span class="pre">subset_cell_fovs</span></code>.</p>
<div class="cell tag_save_cell_masks docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_utils</span><span class="o">.</span><span class="n">save_colored_masks</span><span class="p">(</span>
    <span class="n">fovs</span><span class="o">=</span><span class="n">subset_cell_fovs</span><span class="p">,</span>
    <span class="n">mask_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span><span class="n">cell_output_dir</span><span class="p">,</span> <span class="s2">&quot;cell_masks&quot;</span><span class="p">),</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span><span class="n">cell_output_dir</span><span class="p">,</span> <span class="s2">&quot;cell_mask_colored&quot;</span><span class="p">),</span>
    <span class="n">cluster_id_to_name_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_remap_name</span><span class="p">),</span>
    <span class="n">metacluster_colors</span><span class="o">=</span><span class="n">raw_cmap</span><span class="p">,</span>
    <span class="n">cluster_type</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Load a subset of the cell cluster masks that you would like to preview. If the dimensions or text size of the plot need to be adjusted for optimal viewing, change the <code class="docutils literal notranslate"><span class="pre">figsize</span></code> and <code class="docutils literal notranslate"><span class="pre">dpi</span></code> parameters.</p>
<div class="cell tag_cell_overlay_gen docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">cell_fov</span> <span class="ow">in</span> <span class="n">subset_cell_fovs</span><span class="p">:</span>
    <span class="n">cell_cluster_mask</span> <span class="o">=</span> <span class="n">load_utils</span><span class="o">.</span><span class="n">load_imgs_from_dir</span><span class="p">(</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s2">&quot;cell_masks&quot;</span><span class="p">),</span>
        <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="n">cell_fov</span> <span class="o">+</span> <span class="s2">&quot;_cell_mask.tiff&quot;</span><span class="p">],</span>
        <span class="n">trim_suffix</span><span class="o">=</span><span class="s2">&quot;_cell_mask&quot;</span><span class="p">,</span>
        <span class="n">match_substring</span><span class="o">=</span><span class="s2">&quot;_cell_mask&quot;</span><span class="p">,</span>
        <span class="n">xr_dim_name</span><span class="o">=</span><span class="s2">&quot;cell_mask&quot;</span><span class="p">,</span>
        <span class="n">xr_channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_pixel_cell_cluster</span><span class="p">(</span>
        <span class="n">cell_cluster_mask</span><span class="p">,</span>
        <span class="p">[</span><span class="n">cell_fov</span><span class="p">],</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_remap_name</span><span class="p">),</span>
        <span class="n">metacluster_colors</span><span class="o">=</span><span class="n">raw_cmap</span><span class="p">,</span>
        <span class="n">cluster_type</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
        <span class="c1"># erode=True, 27</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
        <span class="c1"># dpi=150</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Append consensus cluster labels to cell table. The cell table with cell meta cluster labels is saved to <code class="docutils literal notranslate"><span class="pre">{cell_table_path}_cell_labels.csv</span></code></p>
<div class="cell tag_cell_append_meta docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_cluster_utils</span><span class="o">.</span><span class="n">add_consensus_labels_cell_table</span><span class="p">(</span>
    <span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_table_path</span><span class="p">,</span> <span class="n">cluster_counts_size_norm</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="save-images-for-mantis-viewer">
<h3>6.5 Save images for Mantis Viewer<a class="headerlink" href="#save-images-for-mantis-viewer" title="Link to this heading">#</a></h3>
<p>Mantis Viewer is a visualization tool for multi-dimensional imaging in pathology. Learn more about Mantis Viewer in the <span class="xref myst">README</span>.</p>
<div class="cell tag_cell_mantis_project docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_utils</span><span class="o">.</span><span class="n">create_mantis_dir</span><span class="p">(</span>
    <span class="n">fovs</span><span class="o">=</span><span class="n">subset_cell_fovs</span><span class="p">,</span>
    <span class="n">mantis_project_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;mantis&quot;</span><span class="p">),</span>
    <span class="n">img_data_path</span><span class="o">=</span><span class="n">tiff_dir</span><span class="p">,</span>
    <span class="n">mask_output_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;pixie&quot;</span><span class="p">,</span> <span class="n">cell_output_dir</span><span class="p">,</span> <span class="s2">&quot;cell_masks&quot;</span><span class="p">),</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">cell_meta_cluster_remap_name</span><span class="p">),</span>
    <span class="n">seg_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">segmentation_dir</span><span class="p">),</span>
    <span class="n">cluster_type</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">mask_suffix</span><span class="o">=</span><span class="s2">&quot;_cell_mask&quot;</span><span class="p">,</span>
    <span class="n">seg_suffix_name</span><span class="o">=</span><span class="n">seg_suffix</span><span class="p">,</span>
    <span class="c1"># img_sub_folder=img_sub_folder</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="fundamental-analysis">
<h2>7.0 Fundamental Analysis<a class="headerlink" href="#fundamental-analysis" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="n">annotDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">cell_table_path</span><span class="p">)</span>
<span class="n">annotDF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="n">annotDF</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotDF</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD3e&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;SMActin&#39;</span><span class="p">]</span>
<span class="n">protDF</span> <span class="o">=</span> <span class="n">annotDF</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">annotDF</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">channel</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">)]]</span>
<span class="n">protDF</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_size&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-0_nuclear&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-1_nuclear&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-0_cell&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-1_cell&#39;</span><span class="p">,</span> <span class="s1">&#39;fov&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;label_nuclear&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_type&#39;</span><span class="p">]</span>
<span class="n">spatDF</span> <span class="o">=</span> <span class="n">annotDF</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">annotDF</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">channel</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">spatial</span><span class="p">)]]</span>
<span class="n">spatDF</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">protDF</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatDF</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spat_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Users/smith6jt/KINTSUGI/data/1904_CC2B_Spatial&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">spat_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span> <span class="p">(</span><span class="n">protDF</span><span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">spatDF</span>
<span class="n">adata</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spat_dir</span><span class="p">,</span> <span class="s1">&#39;1904_CC2B.h5ad&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spat_dir</span><span class="p">,</span> <span class="s1">&#39;1904_CC2B.h5ad&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata1</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,[</span><span class="s1">&#39;CD3e&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;SMActin&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata1</span><span class="p">,</span> <span class="n">svd_solver</span><span class="o">=</span><span class="s1">&#39;arpack&#39;</span><span class="p">)</span> <span class="c1"># peform PCA</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">adata1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata1</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">rc_context</span>
<span class="k">with</span> <span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">}):</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;leiden&#39;</span><span class="p">],</span> <span class="n">legend_fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;on data&#39;</span><span class="p">,</span> <span class="n">legend_fontoutline</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">add_outline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./src\notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="5_Cluster_Pixels.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Part 5: Cluster pixels.</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1. Import packages.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#this-must-be-done-every-time-the-notebook-is-started-or-restarted">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-directory-paths">2. Define directory paths.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">*This must be done every time the notebook is started or restarted.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-parameters-for-cell-clustering-saved-during-2-cluster-pixels-ipynb">3. Load parameters for cell clustering (saved during <code class="docutils literal notranslate"><span class="pre">2_Cluster_Pixels.ipynb</span></code>)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocess">4. Preprocess</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cell-clustering">5. Cell clustering</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-and-train-cell-som">5.1: Visualize and train cell SOM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-cell-som-clusters">5.2: Assign cell SOM clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-cell-consensus-clustering">5.3 Run cell consensus clustering</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">6. Visualize results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-adjustments-to-relabel-cell-meta-clusters">6.1 Interactive adjustments to relabel cell meta clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#quickstart">Quickstart</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-and-remapping-details">Selection and Remapping details</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#other-features-and-notes">Other features and notes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-cell-som-cluster-average-heatmap-over-channels-z-scored">6.2 Weighted cell SOM cluster average heatmap over channels (z-scored)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weighted-cell-meta-cluster-average-heatmap-over-channels-z-scored">6.3 Weighted cell meta cluster average heatmap over channels (z-scored)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-cell-phenotype-maps">6.4 Generate cell phenotype maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-images-for-mantis-viewer">6.5 Save images for Mantis Viewer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamental-analysis">7.0 Fundamental Analysis</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Justin Smith
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>